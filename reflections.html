<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflections - Auron</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Logto SDK -->
    <script src="https://logto.dev/js/v1.0.0-beta.0"></script>
    <script src="./logto-config.js?v=3"></script>

    <!-- Our Modules -->
    <script src="./js/config.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/api.js"></script>
    <script src="./js/shared.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#000DFF',
                        'primary-dark': '#001AFF',
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        body {
            background: #000000;
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Navigation, LoadingScreen } = window.SharedComponents;

        function ReflectionsApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [conversations, setConversations] = useState([]);
            const [selectedConversation, setSelectedConversation] = useState(null);
            const [conversationDetails, setConversationDetails] = useState(null);
            const [loadingDetails, setLoadingDetails] = useState(false);

            useEffect(() => {
                checkAuth();
            }, []);

            async function checkAuth() {
                const userData = await window.AuthUtils.requireAuth();
                if (userData) {
                    setUser(userData);
                    await loadConversations();
                    setLoading(false);
                }
            }

            async function loadConversations() {
                try {
                    const data = await window.API.getConversations();
                    setConversations(data.conversations || []);
                } catch (err) {
                    console.error('Failed to load conversations:', err);
                }
            }

            async function loadConversationDetails(conversation) {
                setSelectedConversation(conversation);
                setLoadingDetails(true);

                try {
                    // Get signed URL from backend
                    const signedUrl = await window.API.getConversationUrl(conversation.bunny_key);

                    // Fetch conversation from BunnyCDN using signed URL
                    const details = await window.API.fetchConversation(signedUrl);
                    setConversationDetails(details);
                } catch (err) {
                    console.error('Failed to load conversation details:', err);
                    setConversationDetails({ error: err.message });
                } finally {
                    setLoadingDetails(false);
                }
            }

            async function handleSignOut() {
                await window.AuthUtils.signOut();
            }

            if (loading) {
                return <LoadingScreen />;
            }

            return (
                <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column', background: '#000' }}>
                    <Navigation currentPage="/reflections.html" user={user} onSignOut={handleSignOut} />

                    <div style={{ flex: 1, padding: '2rem' }}>
                        <div style={{ maxWidth: '1400px', margin: '0 auto' }}>
                            <h1 style={{
                                fontSize: '2.5rem',
                                fontWeight: '900',
                                color: '#00D9FF',
                                textShadow: '0 0 20px rgba(0, 217, 255, 0.6)',
                                marginBottom: '2rem'
                            }}>
                                Your Reflections
                            </h1>

                            {conversations.length === 0 ? (
                                <div style={{
                                    textAlign: 'center',
                                    padding: '4rem 2rem',
                                    color: '#9CA3AF'
                                }}>
                                    <p style={{ fontSize: '1.25rem', marginBottom: '1rem' }}>No conversations yet</p>
                                    <p>Start a conversation in the Chat to see your reflections here.</p>
                                </div>
                            ) : (
                                <div style={{ display: 'grid', gridTemplateColumns: '300px 1fr', gap: '2rem' }}>
                                    {/* Conversation List */}
                                    <div style={{
                                        background: 'rgba(255, 255, 255, 0.03)',
                                        border: '1px solid rgba(255, 255, 255, 0.05)',
                                        borderRadius: '1rem',
                                        padding: '1rem',
                                        maxHeight: 'calc(100vh - 200px)',
                                        overflowY: 'auto'
                                    }}>
                                        {conversations.map((conv) => (
                                            <div
                                                key={conv.session_id}
                                                onClick={() => loadConversationDetails(conv)}
                                                style={{
                                                    padding: '1rem',
                                                    marginBottom: '0.5rem',
                                                    background: selectedConversation?.session_id === conv.session_id
                                                        ? 'rgba(0, 13, 255, 0.2)'
                                                        : 'rgba(255, 255, 255, 0.02)',
                                                    border: `1px solid ${selectedConversation?.session_id === conv.session_id
                                                        ? 'rgba(0, 13, 255, 0.4)'
                                                        : 'rgba(255, 255, 255, 0.05)'}`,
                                                    borderRadius: '0.5rem',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.2s ease'
                                                }}
                                                onMouseEnter={(e) => {
                                                    if (selectedConversation?.session_id !== conv.session_id) {
                                                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.05)';
                                                    }
                                                }}
                                                onMouseLeave={(e) => {
                                                    if (selectedConversation?.session_id !== conv.session_id) {
                                                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.02)';
                                                    }
                                                }}
                                            >
                                                <p style={{ color: 'white', fontSize: '0.9rem', marginBottom: '0.25rem' }}>
                                                    {new Date(conv.created_at).toLocaleDateString()}
                                                </p>
                                                <p style={{ color: '#9CA3AF', fontSize: '0.75rem' }}>
                                                    {conv.message_count || 0} messages
                                                </p>
                                            </div>
                                        ))}
                                    </div>

                                    {/* Conversation Details */}
                                    <div style={{
                                        background: 'rgba(255, 255, 255, 0.03)',
                                        border: '1px solid rgba(255, 255, 255, 0.05)',
                                        borderRadius: '1rem',
                                        padding: '2rem',
                                        maxHeight: 'calc(100vh - 200px)',
                                        overflowY: 'auto'
                                    }}>
                                        {!selectedConversation && (
                                            <div style={{
                                                textAlign: 'center',
                                                padding: '4rem 2rem',
                                                color: '#9CA3AF'
                                            }}>
                                                <p>Select a conversation to view details</p>
                                            </div>
                                        )}

                                        {loadingDetails && (
                                            <div style={{ textAlign: 'center', padding: '4rem 2rem', color: '#00BFFF' }}>
                                                Loading conversation...
                                            </div>
                                        )}

                                        {!loadingDetails && conversationDetails?.error && (
                                            <div style={{
                                                textAlign: 'center',
                                                padding: '4rem 2rem',
                                                color: '#EF4444'
                                            }}>
                                                <p>Error loading conversation: {conversationDetails.error}</p>
                                            </div>
                                        )}

                                        {!loadingDetails && conversationDetails && !conversationDetails.error && (
                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
                                                {conversationDetails.messages?.map((msg, idx) => (
                                                    <div
                                                        key={idx}
                                                        style={{
                                                            display: 'flex',
                                                            justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start'
                                                        }}
                                                    >
                                                        <div style={{
                                                            maxWidth: '75%',
                                                            padding: '1rem 1.5rem',
                                                            borderRadius: '1rem',
                                                            background: msg.role === 'user'
                                                                ? 'rgba(0, 13, 255, 0.2)'
                                                                : 'rgba(255, 255, 255, 0.05)',
                                                            border: `1px solid ${msg.role === 'user'
                                                                ? 'rgba(0, 13, 255, 0.4)'
                                                                : 'rgba(255, 255, 255, 0.1)'}`
                                                        }}>
                                                            <p style={{
                                                                fontSize: '0.75rem',
                                                                fontWeight: '600',
                                                                color: msg.role === 'user' ? '#00D9FF' : '#00BFFF',
                                                                textTransform: 'uppercase',
                                                                marginBottom: '0.5rem'
                                                            }}>
                                                                {msg.role === 'user' ? 'You' : 'Auron'}
                                                            </p>
                                                            <p style={{ color: 'white', lineHeight: '1.6' }}>
                                                                {msg.content}
                                                            </p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<ReflectionsApp />, document.getElementById('root'));
    </script>
</body>
</html>
