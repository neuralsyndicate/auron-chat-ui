<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Auron</title>

    <!-- Google Fonts: Plus Jakarta Sans (Neural Music brand font) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Logto Browser SDK via ES Module -->
    <script type="module">
        import LogtoClient from 'https://esm.run/@logto/browser';
        window.LogtoClient = LogtoClient;
        window.logtoConfig = {
            endpoint: 'https://auth.neuralsyndicate.com/',
            appId: 'a5m87e4osv2y7vv8asbwu',
        };
        console.log('‚úì Logto SDK loaded successfully');
    </script>

    <script src="logto-config.js?v=3"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#000DFF',
                        'primary-dark': '#001AFF',
                        'ns-black': '#000000',
                        'ns-white': '#FFFFFF',
                        'ns-blue': '#000DFF',
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        /* Neural Syndicate - Cyberpunk Minimalist Design System */
        /* Dark Blue (#000DFF) + Pure Black - Professional/Futuristic */

        :root {
            /* Core Colors - HEAVY Electric Blue (like 43.png) */
            --ns-black: #000000;
            --ns-navy: #0a0a0f;
            --ns-blue-glow: #00D9FF;      /* Bright electric blue - MAIN */
            --ns-blue-bright: #00BFFF;    /* Cyan glow */
            --ns-blue-mid: #0099FF;       /* Medium blue */

            /* Text */
            --ns-white: #FFFFFF;
            --ns-gray: #8899AA;
            --ns-gray-dark: #556677;

            /* Liquid Glass (Apple-style) */
            --glass-bg: rgba(10, 10, 31, 0.4);
            --glass-bg-strong: rgba(10, 10, 31, 0.75);
            --glass-border: rgba(0, 13, 255, 0.12);
            --glass-blur: blur(24px);

            /* Glows - Dark Blue Only */
            --glow-soft: 0 0 15px rgba(0, 13, 255, 0.3);
            --glow-medium: 0 0 25px rgba(0, 13, 255, 0.5);
            --glow-strong: 0 0 45px rgba(0, 13, 255, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background: var(--ns-black);
            margin: 0;
            overflow: hidden;
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Inter', system-ui, sans-serif;
            color: var(--ns-white);
            font-weight: 400;
            letter-spacing: -0.01em;
            -webkit-font-smoothing: antialiased;
        }

        /* Liquid Glass Effect (Apple-inspired) */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            box-shadow:
                0 8px 32px 0 rgba(0, 0, 0, 0.4),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.03),
                inset 0 0 20px 0 rgba(0, 13, 255, 0.02);
        }

        .glass-strong {
            background: var(--glass-bg-strong);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(0, 13, 255, 0.18);
            box-shadow:
                0 16px 48px 0 rgba(0, 0, 0, 0.5),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.05);
        }

        /* Glow Effects - Dark Blue ONLY */
        .glow {
            text-shadow: var(--glow-soft);
        }

        .glow-strong {
            text-shadow: var(--glow-medium);
            filter: drop-shadow(0 0 12px rgba(0, 13, 255, 0.4));
        }

        .neural-glow {
            box-shadow: var(--glow-soft);
        }

        .neural-border {
            border: 1px solid rgba(0, 13, 255, 0.25);
            box-shadow:
                var(--glow-soft),
                inset 0 0 15px rgba(0, 13, 255, 0.04);
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .pulse-line {
            animation: pulse 2s ease-in-out infinite;
        }

        .message {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.98);
            }
        }

        @keyframes blink {
            0%, 49% {
                opacity: 1;
            }
            50%, 100% {
                opacity: 0;
            }
        }

        /* Dialogue Modal - Liquid Glass Cyberpunk Professional */
        .dialogue-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dialogue-modal {
            /* Liquid Glass Effect */
            background: rgba(10, 10, 31, 0.65);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);

            /* HEAVY Blue Glow Border (like 43.png) */
            border: 2px solid rgba(0, 217, 255, 0.4);
            border-radius: 0;

            /* INTENSE Blue Glow */
            box-shadow:
                0 0 0 1px rgba(0, 217, 255, 0.1) inset,
                0 24px 60px 0 rgba(0, 0, 0, 0.8),
                0 0 40px rgba(0, 217, 255, 0.6),
                0 0 80px rgba(0, 217, 255, 0.4),
                0 0 120px rgba(0, 191, 255, 0.3);
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);

            padding: 3rem;
            width: 100vw;
            height: 100vh;
            overflow-y: auto;
            position: relative;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Sci-Fi Shimmer Effects (Neural Music style) */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes shimmer {
            0%, 100% {
                background-position: -200% center;
            }
            50% {
                background-position: 200% center;
            }
        }

        @keyframes glow-pulse {
            0%, 100% {
                box-shadow:
                    0 0 0 1px rgba(255, 255, 255, 0.03) inset,
                    0 24px 60px 0 rgba(0, 0, 0, 0.6),
                    0 0 60px 0 rgba(0, 13, 255, 0.15),
                    0 0 120px 0 rgba(0, 13, 255, 0.08);
            }
            50% {
                box-shadow:
                    0 0 0 1px rgba(255, 255, 255, 0.03) inset,
                    0 24px 60px 0 rgba(0, 0, 0, 0.6),
                    0 0 80px 0 rgba(0, 13, 255, 0.25),
                    0 0 160px 0 rgba(0, 13, 255, 0.15);
            }
        }

        @keyframes subtle-pulse {
            0%, 100% {
                box-shadow: 0 0 40px rgba(0, 191, 255, 0.2), inset 0 2px 0 rgba(255, 255, 255, 0.05);
                border-color: rgba(0, 217, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 50px rgba(0, 191, 255, 0.3), inset 0 2px 0 rgba(255, 255, 255, 0.08);
                border-color: rgba(0, 217, 255, 0.4);
            }
        }

        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Rotating ring shimmer */
        .shimmer-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: inherit;
            border: 1px solid rgba(0, 13, 255, 0.2);
            animation: spin 20s linear infinite;
            pointer-events: none;
        }

        .shimmer-ring::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: inherit;
            background: conic-gradient(
                from 0deg,
                transparent 0%,
                rgba(0, 13, 255, 0.4) 10%,
                transparent 20%,
                transparent 100%
            );
            animation: spin 8s linear infinite reverse;
        }

        /* Sci-fi button with HEAVY blue glow (like 43.png) */
        .btn-sci-fi {
            position: relative;
            background: linear-gradient(
                135deg,
                #00D9FF 0%,
                #00BFFF 50%,
                #00D9FF 100%
            );
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
            transition: all 0.3s ease-out;
            overflow: hidden;
            box-shadow:
                0 0 20px rgba(0, 217, 255, 0.6),
                0 0 40px rgba(0, 191, 255, 0.4);
        }

        .btn-sci-fi:hover {
            transform: scale(1.05);
            box-shadow:
                0 0 30px rgba(0, 217, 255, 0.8),
                0 0 60px rgba(0, 191, 255, 0.6),
                0 0 100px rgba(0, 153, 255, 0.4);
        }

        .btn-sci-fi::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 20%,
                rgba(255, 255, 255, 0.6) 50%,
                transparent 80%
            );
            animation: shimmer 2s linear infinite;
            z-index: 1;
        }

        .btn-sci-fi > * {
            position: relative;
            z-index: 2;
        }

        /* Glass card with hover scale */
        .glass-card {
            transition: all 0.3s ease-out;
        }

        .glass-card:hover {
            transform: scale(1.02) translateY(-4px);
            box-shadow:
                0 0 0 1px rgba(255, 255, 255, 0.05) inset,
                0 8px 32px rgba(0, 0, 0, 0.6),
                0 0 80px rgba(0, 13, 255, 0.2);
        }

        .dialogue-modal-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .dialogue-modal-close:hover {
            color: #000DFF;
            background: rgba(0, 191, 255, 0.1);
        }

        /* Loading Overlay - Professional Dark Blue */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.94);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loading-spinner {
            width: 64px;
            height: 64px;
            border: 3px solid rgba(0, 13, 255, 0.1);
            border-top-color: var(--ns-blue-dark);
            border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
            box-shadow: 0 0 40px rgba(0, 13, 255, 0.2);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Close Button - Minimal Professional */
        .dialogue-modal-close {
            position: absolute;
            top: 1.75rem;
            right: 1.75rem;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: var(--ns-gray);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-weight: 300;
        }

        .dialogue-modal-close:hover {
            background: rgba(0, 13, 255, 0.15);
            border-color: rgba(0, 13, 255, 0.3);
            color: var(--ns-white);
            box-shadow: 0 0 20px rgba(0, 13, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const API_BASE = 'http://86.38.182.54:8001';
        const DIALOGUE_API_BASE = 'https://api.neuralsyndicate.com';  // Backend via Cloudflare Tunnel
        const BFF_API_BASE = 'https://api.combryth-backbone.ch';  // BFF for Neural Music Profile
        const BUNNY_STORAGE_URL = 'https://storage.bunnycdn.com/combryth-data';  // BunnyCDN Storage
        const BUNNY_PASSWORD = 'f528b697-2867-40b5-bf1710764185-4b99-4621';  // Read-only password
        const UNLOCK_THRESHOLD = 10;

        // Helper function to get auth token
        async function getAuthToken() {
            // First try localStorage (cached access token)
            let token = localStorage.getItem('auron_access_token');

            if (token) {
                return token;
            }

            // Get fresh access token from Logto with API resource
            try {
                token = await window.LogtoAuth.getAccessToken(DIALOGUE_API_BASE);
                if (token) {
                    localStorage.setItem('auron_access_token', token);
                    return token;
                }
            } catch (err) {
                console.warn('Could not get access token from Logto:', err);
            }

            return null;
        }

        // AES-256-GCM Decryption for conversations
        async function decryptConversation(encryptedData, encryptionKeyB64) {
            try {
                // Decode base64 encryption key
                const keyBytes = Uint8Array.from(atob(encryptionKeyB64), c => c.charCodeAt(0));

                // Extract IV (first 12 bytes) and ciphertext
                const dataView = new Uint8Array(encryptedData);
                const iv = dataView.slice(0, 12);
                const ciphertext = dataView.slice(12);

                console.log('IV length:', iv.length);
                console.log('Ciphertext length:', ciphertext.length);
                console.log('Key length:', keyBytes.length);

                // Import encryption key
                const key = await crypto.subtle.importKey(
                    'raw',
                    keyBytes,
                    { name: 'AES-GCM' },
                    false,
                    ['decrypt']
                );

                // Decrypt using AES-256-GCM
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    ciphertext
                );

                // Parse decrypted JSON
                const jsonString = new TextDecoder().decode(decrypted);
                return JSON.parse(jsonString);

            } catch (err) {
                console.error('Decryption failed:', err);
                throw new Error(`Failed to decrypt conversation: ${err.message}`);
            }
        }

        // SSE Streaming Constants - Event mapping for real-time progress
        const SSE_STAGE_MESSAGES = {
            'complexity_analyzing': 'Analyzing message complexity...',
            'complexity_complete': 'Complexity analysis complete',
            'emotion_analyzing': 'Detecting emotional patterns...',
            'emotion_complete': 'Emotional patterns identified',
            'domain_analyzing': 'Mapping knowledge domains...',
            'domain_complete': 'Knowledge domains mapped',
            'trigger_analyzing': 'Identifying psychological patterns...',
            'trigger_complete': 'Psychological patterns recognized',
            'blueprint_retrieved': 'Neural Music framework retrieved...',
            'blueprint_skipped': 'Framework check complete',
            'web_search_analyzing': 'Searching research papers...',
            'web_search_complete': 'Research complete',
            'auron_thinking': 'Crafting response...',
            'auron_complete': 'Response ready',
            'complete': 'Complete'
        };

        const SSE_STAGE_PROGRESS = {
            'complexity_analyzing': 5,
            'complexity_complete': 12,
            'emotion_analyzing': 20,
            'emotion_complete': 30,
            'domain_analyzing': 40,
            'domain_complete': 50,
            'trigger_analyzing': 60,
            'trigger_complete': 70,
            'blueprint_retrieved': 72,
            'blueprint_skipped': 72,
            'web_search_analyzing': 75,
            'web_search_complete': 85,
            'auron_thinking': 90,
            'auron_complete': 95,
            'complete': 100
        };

        const SSE_STAGE_ICONS = {
            'analyzing': '‚öôÔ∏è',
            'complete': '‚úÖ',
            'error': '‚ùå'
        };

        // Beautiful Loading Screen Component
        function LoadingScreen() {
            const [dots, setDots] = useState('');

            useEffect(() => {
                const interval = setInterval(() => {
                    setDots(prev => prev.length >= 3 ? '' : prev + '.');
                }, 500);
                return () => clearInterval(interval);
            }, []);

            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.92)',
                    backdropFilter: 'blur(20px)',
                    WebkitBackdropFilter: 'blur(20px)',
                    zIndex: 2000,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    animation: 'fadeIn 0.3s ease'
                }}>
                    <div style={{
                        position: 'relative',
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        gap: '2rem'
                    }}>
                        {/* Orbital Rings */}
                        <div style={{
                            position: 'relative',
                            width: '200px',
                            height: '200px'
                        }}>
                            {/* Outer Ring */}
                            <div style={{
                                position: 'absolute',
                                inset: 0,
                                border: '2px solid rgba(0, 217, 255, 0.3)',
                                borderRadius: '50%',
                                animation: 'spin 3s linear infinite'
                            }} />

                            {/* Middle Ring */}
                            <div style={{
                                position: 'absolute',
                                inset: '20px',
                                border: '2px solid rgba(0, 217, 255, 0.5)',
                                borderRadius: '50%',
                                borderTopColor: 'transparent',
                                borderLeftColor: 'transparent',
                                animation: 'spin 2s linear infinite reverse'
                            }} />

                            {/* Inner Ring */}
                            <div style={{
                                position: 'absolute',
                                inset: '40px',
                                border: '2px solid rgba(0, 217, 255, 0.7)',
                                borderRadius: '50%',
                                borderRightColor: 'transparent',
                                borderBottomColor: 'transparent',
                                animation: 'spin 1.5s linear infinite'
                            }} />

                            {/* Center Brain Icon */}
                            <div style={{
                                position: 'absolute',
                                inset: 0,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '4rem',
                                animation: 'pulse 2s ease-in-out infinite',
                                filter: 'drop-shadow(0 0 30px rgba(0, 217, 255, 0.8))'
                            }}>
                                üß†
                            </div>
                        </div>

                        {/* AURON Text */}
                        <h2 style={{
                            fontSize: '2.5rem',
                            fontWeight: '900',
                            color: '#00D9FF',
                            textShadow: '0 0 30px rgba(0, 217, 255, 0.8), 0 0 60px rgba(0, 191, 255, 0.6)',
                            letterSpacing: '0.2em',
                            margin: 0
                        }}>
                            AURON
                        </h2>

                        {/* Processing Text */}
                        <p style={{
                            fontSize: '1.2rem',
                            color: '#00BFFF',
                            textShadow: '0 0 20px rgba(0, 217, 255, 0.6)',
                            fontWeight: '600',
                            margin: 0
                        }}>
                            Processing{dots}
                        </p>

                        {/* Particle Dots */}
                        <div style={{
                            display: 'flex',
                            gap: '1rem',
                            marginTop: '1rem'
                        }}>
                            {[0, 1, 2].map(i => (
                                <div key={i} style={{
                                    width: '12px',
                                    height: '12px',
                                    borderRadius: '50%',
                                    background: '#00D9FF',
                                    boxShadow: '0 0 20px rgba(0, 217, 255, 0.8)',
                                    animation: `bounce 1.5s ease-in-out infinite`,
                                    animationDelay: `${i * 0.2}s`
                                }} />
                            ))}
                        </div>
                    </div>

                    <style>{`
                        @keyframes spin {
                            from { transform: rotate(0deg); }
                            to { transform: rotate(360deg); }
                        }
                        @keyframes pulse {
                            0%, 100% { transform: scale(1); opacity: 1; }
                            50% { transform: scale(1.1); opacity: 0.8; }
                        }
                        @keyframes bounce {
                            0%, 100% { transform: translateY(0); }
                            50% { transform: translateY(-10px); }
                        }
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                    `}</style>
                </div>
            );
        }

        // Stage configurations with unique particle behaviors
        const STAGE_CONFIG = {
            'complexity': {
                label: 'Deep Structure',
                color: 'rgba(0, 217, 255, 0.6)',
                particleCount: 30,
                connectionDistance: 100,
                speed: 0.6
            },
            'emotion': {
                label: 'Resonant Flow',
                color: 'rgba(138, 43, 226, 0.6)',
                particleCount: 20,
                connectionDistance: 110,
                speed: 0.4,
                flow: true
            },
            'domain': {
                label: 'Spatial Context',
                color: 'rgba(0, 217, 255, 0.6)',
                particleCount: 25,
                connectionDistance: 90,
                speed: 0.5,
                converge: true
            },
            'trigger': {
                label: 'Pattern Trace',
                color: 'rgba(0, 150, 255, 0.6)',
                particleCount: 28,
                connectionDistance: 105,
                speed: 0.45,
                geometric: true
            },
            'blueprint': {
                label: 'Framework Retrieval',
                color: 'rgba(147, 51, 234, 0.6)',
                particleCount: 22,
                connectionDistance: 95,
                speed: 0.55,
                pulse: true
            },
            'web_search': {
                label: 'Knowledge Archive',
                color: 'rgba(0, 217, 255, 0.6)',
                particleCount: 25,
                connectionDistance: 120,
                speed: 1.0,
                stream: true
            },
            'auron': {
                label: 'Neural Synthesis',
                color: 'rgba(0, 217, 255, 0.8)',
                particleCount: 30,
                connectionDistance: 100,
                speed: 0.6,
                neural: true
            }
        };

        // Particle system for subtle background animation
        class ParticleSystem {
            constructor(canvasId, stageType) {
                this.canvas = document.getElementById(canvasId);
                if (!this.canvas) return;

                this.ctx = this.canvas.getContext('2d');
                this.particles = [];
                this.stageType = stageType;
                this.animationId = null;

                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.init();
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            init() {
                // Keep it minimal - only 20 particles (subtle, not cringe!)
                const count = 20;
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        vx: (Math.random() - 0.5) * 0.3, // Slow, gentle movement
                        vy: (Math.random() - 0.5) * 0.3,
                        size: Math.random() * 2 + 1,
                        opacity: Math.random() * 0.3 + 0.1, // Very subtle
                        life: Math.random() * 100
                    });
                }
            }

            updateStage(newStage) {
                this.stageType = newStage;
            }

            animate() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw subtle particles
                this.particles.forEach((p, index) => {
                    // Update position (slow movement)
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life += 0.5;

                    // Wrap around edges
                    if (p.x < 0) p.x = this.canvas.width;
                    if (p.x > this.canvas.width) p.x = 0;
                    if (p.y < 0) p.y = this.canvas.height;
                    if (p.y > this.canvas.height) p.y = 0;

                    // Subtle opacity pulse
                    p.opacity = 0.1 + Math.sin(p.life * 0.02) * 0.15;

                    // Draw particle (very subtle)
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    this.ctx.fillStyle = `rgba(0, 217, 255, ${p.opacity})`;
                    this.ctx.fill();

                    // Draw subtle connections (only to nearby particles)
                    this.particles.slice(index + 1).forEach(p2 => {
                        const dx = p2.x - p.x;
                        const dy = p2.y - p.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);

                        if (dist < 150) { // Only connect nearby
                            this.ctx.beginPath();
                            this.ctx.moveTo(p.x, p.y);
                            this.ctx.lineTo(p2.x, p2.y);
                            this.ctx.strokeStyle = `rgba(0, 217, 255, ${0.05 * (1 - dist / 150)})`;
                            this.ctx.lineWidth = 0.5;
                            this.ctx.stroke();
                        }
                    });
                });

                this.animationId = requestAnimationFrame(() => this.animate());
            }

            start() {
                if (!this.animationId) {
                    this.animate();
                }
            }

            stop() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
            }

            destroy() {
                this.stop();
                this.particles = [];
            }
        }

        // MicroCanvas - Tiny particle canvas for each stage
        function MicroCanvas({ stageType, isActive, isCompleted, size = 32 }) {
            const canvasRef = React.useRef(null);
            const particlesRef = React.useRef([]);
            const animationIdRef = React.useRef(null);

            const config = STAGE_CONFIG[stageType] || {};

            React.useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                canvas.width = size;
                canvas.height = size;

                // Initialize particles based on stage config
                particlesRef.current = [];
                const count = config.particleCount || 8;

                for (let i = 0; i < count; i++) {
                    particlesRef.current.push({
                        x: Math.random() * size,
                        y: Math.random() * size,
                        vx: (Math.random() - 0.5) * (config.speed || 0.3),
                        vy: (Math.random() - 0.5) * (config.speed || 0.3),
                        size: Math.random() * 1.7 + 0.8,
                        opacity: Math.random() * 0.3 + 0.3,
                        life: Math.random() * 100,
                        angle: Math.random() * Math.PI * 2
                    });
                }

                // Animation loop
                const animate = () => {
                    ctx.clearRect(0, 0, size, size);

                    const rgb = config.color ?
                        config.color.match(/\d+/g).slice(0, 3).join(', ') :
                        '0, 217, 255';

                    particlesRef.current.forEach((p, index) => {
                        // Update based on stage behavior
                        if (config.flow) {
                            // Emotion: flowing wave motion
                            p.y += Math.sin(p.life * 0.05) * 0.3;
                            p.x += p.vx;
                        } else if (config.converge) {
                            // Domain: converge to center
                            const dx = size / 2 - p.x;
                            const dy = size / 2 - p.y;
                            p.x += dx * 0.02;
                            p.y += dy * 0.02;
                        } else if (config.geometric) {
                            // Trigger: circular pattern
                            p.angle += 0.02;
                            p.x = size / 2 + Math.cos(p.angle) * 10;
                            p.y = size / 2 + Math.sin(p.angle) * 10;
                        } else if (config.stream) {
                            // Web_search: horizontal stream
                            p.x += p.vx * 2;
                            p.y += Math.sin(p.x * 0.1) * 0.5;
                        } else if (config.pulse) {
                            // Blueprint: pulsing expansion/contraction from center
                            const distance = Math.sqrt((p.x - size/2)**2 + (p.y - size/2)**2);
                            const pulsePhase = Math.sin(p.life * 0.04) * 0.5;
                            const dx = (p.x - size/2) / (distance || 1);
                            const dy = (p.y - size/2) / (distance || 1);
                            p.x += dx * pulsePhase + p.vx;
                            p.y += dy * pulsePhase + p.vy;
                        } else {
                            // Default: random movement
                            p.x += p.vx;
                            p.y += p.vy;
                        }

                        p.life += 0.5;

                        // Wrap edges
                        if (p.x < 0) p.x = size;
                        if (p.x > size) p.x = 0;
                        if (p.y < 0) p.y = size;
                        if (p.y > size) p.y = 0;

                        // Pulse opacity
                        p.opacity = 0.3 + Math.sin(p.life * 0.03) * 0.3;

                        // Draw particle with glow
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        const finalOpacity = p.opacity * (isActive ? 1 : 0.3);
                        ctx.fillStyle = `rgba(${rgb}, ${finalOpacity})`;
                        ctx.shadowBlur = 3;
                        ctx.shadowColor = `rgba(${rgb}, ${finalOpacity * 0.8})`;
                        ctx.fill();
                        ctx.shadowBlur = 0;

                        // Draw connections with pulsing
                        if (config.neural || config.particleCount > 10) {
                            particlesRef.current.slice(index + 1).forEach(p2 => {
                                const dx = p2.x - p.x;
                                const dy = p2.y - p.y;
                                const dist = Math.sqrt(dx * dx + dy * dy);

                                if (dist < (config.connectionDistance || 60) * (size / 48)) {
                                    ctx.beginPath();
                                    ctx.moveTo(p.x, p.y);
                                    ctx.lineTo(p2.x, p2.y);
                                    // Pulsing connection based on combined particle life
                                    const pulsePhase = Math.sin((p.life + p2.life) * 0.02) * 0.15 + 0.85;
                                    const baseOpacity = 0.25 * (1 - dist / (config.connectionDistance || 60));
                                    const lineOpacity = baseOpacity * pulsePhase * (isActive ? 1 : 0.3);
                                    ctx.strokeStyle = `rgba(${rgb}, ${lineOpacity})`;
                                    ctx.lineWidth = 0.5;
                                    ctx.stroke();
                                }
                            });
                        }
                    });

                    animationIdRef.current = requestAnimationFrame(animate);
                };

                if (isActive || !isCompleted) {
                    animate();
                }

                return () => {
                    if (animationIdRef.current) {
                        cancelAnimationFrame(animationIdRef.current);
                    }
                };
            }, [stageType, isActive, isCompleted, size]);

            return (
                <canvas
                    ref={canvasRef}
                    style={{
                        width: `${size}px`,
                        height: `${size}px`,
                        opacity: isCompleted ? 0.3 : (isActive ? 1 : 0.5),
                        transition: 'opacity 0.3s ease'
                    }}
                />
            );
        }

        // UserAvatarDropdown - Top-right user menu with avatar initial
        function UserAvatarDropdown({ username }) {
            const [isOpen, setIsOpen] = React.useState(false);
            const dropdownRef = React.useRef(null);

            // Get first letter of username (uppercase)
            const initial = username.charAt(0).toUpperCase();

            // Close dropdown when clicking outside
            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            return (
                <div ref={dropdownRef} style={{ position: 'relative' }}>
                    {/* Avatar Button */}
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        style={{
                            width: '40px',
                            height: '40px',
                            borderRadius: '50%',
                            background: 'rgba(0, 217, 255, 0.1)',
                            border: '1px solid rgba(0, 217, 255, 0.3)',
                            color: '#00D9FF',
                            fontSize: '1rem',
                            fontWeight: '600',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            cursor: 'pointer',
                            transition: 'all 0.2s ease',
                            boxShadow: isOpen ? '0 0 20px rgba(0, 217, 255, 0.4)' : 'none'
                        }}
                        onMouseEnter={(e) => {
                            e.currentTarget.style.background = 'rgba(0, 217, 255, 0.15)';
                            e.currentTarget.style.boxShadow = '0 0 20px rgba(0, 217, 255, 0.4)';
                        }}
                        onMouseLeave={(e) => {
                            if (!isOpen) {
                                e.currentTarget.style.background = 'rgba(0, 217, 255, 0.1)';
                                e.currentTarget.style.boxShadow = 'none';
                            }
                        }}
                    >
                        {initial}
                    </button>

                    {/* Dropdown Menu */}
                    {isOpen && (
                        <div style={{
                            position: 'absolute',
                            top: '50px',
                            right: '0',
                            width: '200px',
                            background: 'rgba(10, 10, 31, 0.75)',
                            backdropFilter: 'blur(24px)',
                            WebkitBackdropFilter: 'blur(24px)',
                            border: '1px solid rgba(0, 217, 255, 0.12)',
                            borderRadius: '12px',
                            padding: '0.5rem',
                            boxShadow: '0 8px 32px rgba(0, 0, 0, 0.5)',
                            zIndex: 100,
                            animation: 'slideDown 0.2s ease'
                        }}>
                            {/* Username Header */}
                            <div style={{
                                padding: '0.75rem',
                                borderBottom: '1px solid rgba(0, 217, 255, 0.08)',
                                marginBottom: '0.5rem'
                            }}>
                                <p style={{
                                    fontSize: '0.875rem',
                                    fontWeight: '600',
                                    color: 'rgba(255, 255, 255, 0.9)',
                                    margin: 0
                                }}>
                                    {username}
                                </p>
                                <p style={{
                                    fontSize: '0.75rem',
                                    color: 'rgba(255, 255, 255, 0.5)',
                                    margin: '0.25rem 0 0 0'
                                }}>
                                    Neural Music User
                                </p>
                            </div>

                            {/* Menu Items */}
                            <button
                                onClick={() => { /* TODO: Navigate to profile */ }}
                                style={{
                                    width: '100%',
                                    padding: '0.75rem',
                                    background: 'transparent',
                                    border: 'none',
                                    borderRadius: '8px',
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    fontSize: '0.875rem',
                                    textAlign: 'left',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s ease',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.75rem'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.background = 'rgba(0, 217, 255, 0.08)';
                                    e.currentTarget.style.color = 'rgba(255, 255, 255, 0.9)';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = 'rgba(255, 255, 255, 0.7)';
                                }}
                            >
                                <span>üë§</span> Profile
                            </button>

                            <button
                                onClick={() => { /* TODO: Navigate to settings */ }}
                                style={{
                                    width: '100%',
                                    padding: '0.75rem',
                                    background: 'transparent',
                                    border: 'none',
                                    borderRadius: '8px',
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    fontSize: '0.875rem',
                                    textAlign: 'left',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s ease',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.75rem'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.background = 'rgba(0, 217, 255, 0.08)';
                                    e.currentTarget.style.color = 'rgba(255, 255, 255, 0.9)';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = 'rgba(255, 255, 255, 0.7)';
                                }}
                            >
                                <span>‚öôÔ∏è</span> Settings
                            </button>

                            <button
                                onClick={() => { /* TODO: Navigate to reflections */ }}
                                style={{
                                    width: '100%',
                                    padding: '0.75rem',
                                    background: 'transparent',
                                    border: 'none',
                                    borderRadius: '8px',
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    fontSize: '0.875rem',
                                    textAlign: 'left',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s ease',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.75rem'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.background = 'rgba(0, 217, 255, 0.08)';
                                    e.currentTarget.style.color = 'rgba(255, 255, 255, 0.9)';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = 'rgba(255, 255, 255, 0.7)';
                                }}
                            >
                                <span>üìö</span> Reflections
                            </button>

                            <div style={{
                                height: '1px',
                                background: 'rgba(0, 217, 255, 0.08)',
                                margin: '0.5rem 0'
                            }}></div>

                            <button
                                onClick={() => { /* TODO: Sign out */ }}
                                style={{
                                    width: '100%',
                                    padding: '0.75rem',
                                    background: 'transparent',
                                    border: 'none',
                                    borderRadius: '8px',
                                    color: 'rgba(255, 100, 100, 0.7)',
                                    fontSize: '0.875rem',
                                    textAlign: 'left',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s ease',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.75rem'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.background = 'rgba(255, 100, 100, 0.1)';
                                    e.currentTarget.style.color = 'rgba(255, 100, 100, 0.9)';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.background = 'transparent';
                                    e.currentTarget.style.color = 'rgba(255, 100, 100, 0.7)';
                                }}
                            >
                                <span>üö™</span> Sign Out
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // ThinkingPanel - Minimalist bottom bar with micro canvas stage previews
        function ThinkingPanel({ stage, progress, completedStages, isFading }) {
            const canvasRef = React.useRef(null);
            const particleSystemRef = React.useRef(null);

            // Extract stage category
            const getStageCategory = (stageName) => {
                if (!stageName) return null;
                if (stageName.startsWith('complexity')) return 'complexity';
                if (stageName.startsWith('emotion')) return 'emotion';
                if (stageName.startsWith('domain')) return 'domain';
                if (stageName.startsWith('trigger')) return 'trigger';
                if (stageName.startsWith('blueprint')) return 'blueprint';
                if (stageName.startsWith('web_search')) return 'web_search';
                if (stageName.startsWith('auron')) return 'auron';
                return null;
            };

            const currentCategory = getStageCategory(stage);
            const completedCategories = completedStages
                ? [...new Set(completedStages.map(s => getStageCategory(s)).filter(Boolean))]
                : [];

            const allStages = ['complexity', 'emotion', 'domain', 'trigger', 'blueprint', 'web_search', 'auron'];

            // Initialize particle system for background
            React.useEffect(() => {
                if (canvasRef.current && !particleSystemRef.current) {
                    particleSystemRef.current = new ParticleSystem('thinking-canvas-bg', currentCategory);
                    particleSystemRef.current.start();
                }

                return () => {
                    if (particleSystemRef.current) {
                        particleSystemRef.current.destroy();
                        particleSystemRef.current = null;
                    }
                };
            }, []);

            // Update stage
            React.useEffect(() => {
                if (particleSystemRef.current && currentCategory) {
                    particleSystemRef.current.updateStage(currentCategory);
                }
            }, [currentCategory]);

            return (
                <>
                    {/* Subtle particle canvas background */}
                    <canvas
                        id="thinking-canvas-bg"
                        ref={canvasRef}
                        style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            width: '100%',
                            height: '100%',
                            pointerEvents: 'none',
                            zIndex: 1999,
                            opacity: isFading ? 0 : 0.3,
                            transition: 'opacity 1.2s cubic-bezier(0.16, 1, 0.3, 1)'
                        }}
                    />

                    {/* Subtle dark overlay */}
                    <div style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        background: 'rgba(0, 0, 0, 0.6)',
                        backdropFilter: 'blur(8px)',
                        WebkitBackdropFilter: 'blur(8px)',
                        zIndex: 2000,
                        opacity: isFading ? 0 : 1,
                        transition: 'opacity 1.2s cubic-bezier(0.16, 1, 0.3, 1)'
                    }} />

                    {/* Center progress panel */}
                    <div style={{
                        position: 'fixed',
                        top: '50%',
                        left: '50%',
                        transform: isFading ? 'translate(-50%, -45%)' : 'translate(-50%, -50%)',
                        width: '700px',
                        maxWidth: '90vw',
                        zIndex: 2001,
                        opacity: isFading ? 0 : 1,
                        transition: 'all 1.2s cubic-bezier(0.16, 1, 0.3, 1)'
                    }}>
                        {/* Current stage text */}
                        {stage && SSE_STAGE_MESSAGES[stage] && (
                            <div style={{
                                textAlign: 'center',
                                marginBottom: '1.5rem',
                                fontSize: '1rem',
                                fontWeight: '500',
                                color: 'rgba(255, 255, 255, 0.7)',
                                letterSpacing: '-0.01em'
                            }}>
                                {SSE_STAGE_MESSAGES[stage]}
                            </div>
                        )}

                        {/* Progress bar */}
                        <div style={{
                            position: 'relative',
                            width: '100%',
                            height: '3px',
                            background: 'rgba(255, 255, 255, 0.08)',
                            borderRadius: '1.5px',
                            overflow: 'hidden',
                            marginBottom: '2rem'
                        }}>
                            <div style={{
                                position: 'absolute',
                                left: 0,
                                top: 0,
                                height: '100%',
                                width: `${progress}%`,
                                background: 'linear-gradient(90deg, #000DFF 0%, #00D9FF 100%)',
                                borderRadius: '1.5px',
                                transition: 'width 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                                boxShadow: '0 0 8px rgba(0, 217, 255, 0.4)'
                            }} />
                        </div>

                        {/* Stage micro canvases row */}
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            gap: '1rem'
                        }}>
                            {allStages.map((stageCategory) => {
                                const config = STAGE_CONFIG[stageCategory];
                                const isCompleted = completedCategories.includes(stageCategory);
                                const isCurrent = currentCategory === stageCategory;
                                const isUpcoming = !isCompleted && !isCurrent;

                                return (
                                    <div key={stageCategory} style={{
                                        flex: 1,
                                        display: 'flex',
                                        flexDirection: 'column',
                                        alignItems: 'center',
                                        gap: '0.75rem',
                                        opacity: isUpcoming ? 0.3 : 1,
                                        transition: 'opacity 0.3s ease'
                                    }}>
                                        {/* Micro canvas */}
                                        <div style={{
                                            width: '80px',
                                            height: '80px',
                                            borderRadius: '12px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            background: isCurrent
                                                ? 'rgba(0, 217, 255, 0.08)'
                                                : isCompleted
                                                ? 'rgba(0, 217, 255, 0.04)'
                                                : 'rgba(255, 255, 255, 0.02)',
                                            border: `1px solid ${
                                                isCurrent ? 'rgba(0, 217, 255, 0.25)'
                                                : isCompleted ? 'rgba(0, 217, 255, 0.12)'
                                                : 'rgba(255, 255, 255, 0.04)'
                                            }`,
                                            boxShadow: isCurrent
                                                ? '0 0 20px rgba(0, 217, 255, 0.4)'
                                                : 'none',
                                            position: 'relative',
                                            transition: 'all 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                                            overflow: 'hidden'
                                        }}>
                                            {isCompleted ? (
                                                <div style={{
                                                    fontSize: '1.5rem',
                                                    color: 'rgba(0, 217, 255, 0.7)'
                                                }}>‚úì</div>
                                            ) : (
                                                <MicroCanvas
                                                    stageType={stageCategory}
                                                    isActive={isCurrent}
                                                    isCompleted={isCompleted}
                                                    size={64}
                                                />
                                            )}
                                            {isCurrent && (
                                                <div style={{
                                                    position: 'absolute',
                                                    top: '2px',
                                                    right: '2px',
                                                    width: '8px',
                                                    height: '8px',
                                                    background: '#00D9FF',
                                                    borderRadius: '50%',
                                                    boxShadow: '0 0 8px rgba(0, 217, 255, 0.8)'
                                                }} />
                                            )}
                                        </div>

                                        {/* Label */}
                                        <div style={{
                                            fontSize: '0.875rem',
                                            fontWeight: '500',
                                            color: isCurrent
                                                ? 'rgba(0, 217, 255, 0.85)'
                                                : isCompleted
                                                ? 'rgba(255, 255, 255, 0.5)'
                                                : 'rgba(255, 255, 255, 0.3)',
                                            textAlign: 'center',
                                            letterSpacing: '-0.005em'
                                        }}>
                                            {config.label}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* Progress percentage */}
                        <div style={{
                            textAlign: 'center',
                            marginTop: '1.25rem',
                            fontSize: '0.875rem',
                            fontWeight: '600',
                            color: 'rgba(0, 217, 255, 0.7)',
                            fontVariantNumeric: 'tabular-nums'
                        }}>
                            {Math.round(progress)}%
                        </div>
                    </div>
                </>
            );
        }

        // SSE Chat Helper - Handles streaming chat connection
        async function connectSSEChat({
            message,
            sessionId,
            token,
            onProgress,
            onBlueprintRetrieved,
            onBlueprintSkipped,
            onAuronGenerating,
            onAuronToken,
            onAuronComplete,
            onComplete,
            onError
        }) {
            try {
                // Step 1: POST to /chat/stream to initiate streaming
                console.log('üîÑ Initiating SSE stream for message:', message.substring(0, 50) + '...');

                const initResponse = await fetch(`${DIALOGUE_API_BASE}/chat/stream`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        metadata: { session_id: sessionId || null }
                    })
                });

                if (!initResponse.ok) {
                    throw new Error(`Failed to initiate stream: ${initResponse.status}`);
                }

                const { session_id: sseSessionId, status } = await initResponse.json();
                console.log(`‚úÖ SSE session created: ${sseSessionId}, status: ${status}`);

                // Step 2: Connect to SSE stream endpoint
                const eventSourceUrl = `${DIALOGUE_API_BASE}/chat/stream/${sseSessionId}?token=${encodeURIComponent(token)}`;
                console.log('üîå Connecting to EventSource:', eventSourceUrl);

                const eventSource = new EventSource(eventSourceUrl);

                // Track connection state
                let isComplete = false;

                // Handle all progress events (analysis stages only)
                const progressEvents = [
                    'complexity_analyzing', 'complexity_complete',
                    'emotion_analyzing', 'emotion_complete',
                    'domain_analyzing', 'domain_complete',
                    'trigger_analyzing', 'trigger_complete',
                    'web_search_analyzing', 'web_search_complete'
                ];

                progressEvents.forEach(eventType => {
                    eventSource.addEventListener(eventType, (e) => {
                        try {
                            const data = JSON.parse(e.data);
                            // console.log(`üì° SSE Event: ${eventType}`, data);

                            if (onProgress) {
                                onProgress({
                                    type: eventType,
                                    data: data,
                                    progress: SSE_STAGE_PROGRESS[eventType] || 0
                                });
                            }
                        } catch (err) {
                            console.error(`Error parsing ${eventType} event:`, err);
                        }
                    });
                });

                // Handle Blueprint agent events
                eventSource.addEventListener('blueprint_retrieved', (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        console.log('üìò SSE Event: blueprint_retrieved', data);

                        // Trigger progress update for ThinkingPanel
                        if (onProgress) {
                            onProgress({
                                type: 'blueprint_retrieved',
                                data: data,
                                progress: SSE_STAGE_PROGRESS['blueprint_retrieved'] || 0
                            });
                        }

                        if (onBlueprintRetrieved) {
                            onBlueprintRetrieved(data);
                        }
                    } catch (err) {
                        console.error('Error parsing blueprint_retrieved event:', err);
                    }
                });

                eventSource.addEventListener('blueprint_skipped', (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        console.log('üìò SSE Event: blueprint_skipped', data);

                        // Trigger progress update for ThinkingPanel (treat as complete)
                        if (onProgress) {
                            onProgress({
                                type: 'blueprint_skipped',
                                data: data,
                                progress: SSE_STAGE_PROGRESS['blueprint_skipped'] || 0
                            });
                        }

                        if (onBlueprintSkipped) {
                            onBlueprintSkipped(data);
                        }
                    } catch (err) {
                        console.error('Error parsing blueprint_skipped event:', err);
                    }
                });

                // Handle Auron token streaming events
                eventSource.addEventListener('auron_generating', (e) => {
                    try {
                        // console.log('üéØ SSE Event: auron_generating - Auron is responding...');
                        if (onAuronGenerating) {
                            onAuronGenerating();
                        }
                    } catch (err) {
                        console.error('Error handling auron_generating event:', err);
                    }
                });

                eventSource.addEventListener('auron_token', (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        const token = data.token;
                        // console.log(`üìù SSE Event: auron_token - "${token}"`);
                        if (onAuronToken) {
                            onAuronToken(token);
                        }
                    } catch (err) {
                        console.error('Error parsing auron_token event:', err);
                    }
                });

                eventSource.addEventListener('auron_complete', (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        // console.log('‚úÖ SSE Event: auron_complete - Final structured response:', data);
                        if (onAuronComplete) {
                            onAuronComplete(data);
                        }
                    } catch (err) {
                        console.error('Error parsing auron_complete event:', err);
                    }
                });

                // Handle complete event (final result)
                eventSource.addEventListener('complete', (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        console.log('‚úÖ SSE Complete:', data);

                        isComplete = true;
                        eventSource.close();

                        if (onComplete) {
                            onComplete(data.result);
                        }
                    } catch (err) {
                        console.error('Error parsing complete event:', err);
                        eventSource.close();
                        if (onError) {
                            onError(new Error('Failed to parse final result'));
                        }
                    }
                });

                // Handle error events from server
                eventSource.addEventListener('error_event', (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        console.error('‚ùå SSE Error Event:', data);

                        eventSource.close();
                        if (onError) {
                            onError(new Error(data.error || 'Unknown error'));
                        }
                    } catch (err) {
                        console.error('Error parsing error event:', err);
                    }
                });

                // Handle EventSource connection errors
                eventSource.onerror = (error) => {
                    if (!isComplete) {
                        console.error('‚ùå EventSource connection error:', error);
                        eventSource.close();

                        if (onError) {
                            onError(new Error('SSE connection failed'));
                        }
                    }
                };

                // Handle keepalive pings
                eventSource.addEventListener('ping', (e) => {
                    console.log('üíì SSE Keepalive ping received');
                });

                // Connection timeout (60 seconds)
                const timeout = setTimeout(() => {
                    if (!isComplete) {
                        console.error('‚è±Ô∏è SSE connection timeout');
                        eventSource.close();
                        if (onError) {
                            onError(new Error('Connection timeout'));
                        }
                    }
                }, 60000);

                // Return cleanup function
                return () => {
                    clearTimeout(timeout);
                    if (!isComplete) {
                        eventSource.close();
                    }
                };

            } catch (error) {
                console.error('‚ùå Failed to connect SSE:', error);
                if (onError) {
                    onError(error);
                }
                return () => {}; // Return empty cleanup
            }
        }

        // Blueprint Floating Panel - Appears on right side on hover
        function BlueprintFloatingPanel({ sources, isOpen, onClose }) {
            const panelRef = React.useRef(null);

            if (!sources || sources.length === 0 || !isOpen) return null;

            return (
                <>
                    {/* Backdrop - subtle, doesn't close on click for hover UX */}
                    <div style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        background: 'rgba(0, 0, 0, 0.2)',
                        backdropFilter: 'blur(2px)',
                        opacity: isOpen ? 1 : 0,
                        transition: 'opacity 0.3s ease',
                        zIndex: 949,
                        pointerEvents: isOpen ? 'auto' : 'none'
                    }}></div>

                    {/* Floating Panel */}
                    <div
                        ref={panelRef}
                        onMouseLeave={onClose}
                        style={{
                            position: 'fixed',
                            right: isOpen ? '24px' : '-420px',
                            top: '50%',
                            transform: 'translateY(-50%)',
                            width: '420px',
                            maxHeight: '85vh',
                            background: 'rgba(10, 10, 31, 0.95)',
                            backdropFilter: 'blur(40px)',
                            border: '1px solid rgba(0, 217, 255, 0.3)',
                            borderRadius: '16px',
                            boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(0, 217, 255, 0.1)',
                            opacity: isOpen ? 1 : 0,
                            transition: 'all 0.3s cubic-bezier(0.22, 1, 0.36, 1)',
                            zIndex: 950,
                            overflow: 'hidden',
                            display: 'flex',
                            flexDirection: 'column'
                        }}
                    >
                        {/* Header */}
                        <div style={{
                            padding: '1.5rem',
                            borderBottom: '1px solid rgba(0, 217, 255, 0.15)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                <span style={{ fontSize: '1.5rem' }}>üìò</span>
                                <h3 style={{
                                    margin: 0,
                                    fontSize: '1.125rem',
                                    fontWeight: '600',
                                    color: 'rgba(0, 217, 255, 0.9)',
                                    letterSpacing: '0.02em'
                                }}>
                                    Neural Music Blueprint
                                </h3>
                            </div>
                            <button
                                onClick={onClose}
                                style={{
                                    background: 'transparent',
                                    border: 'none',
                                    color: 'rgba(255, 255, 255, 0.6)',
                                    fontSize: '1.5rem',
                                    cursor: 'pointer',
                                    padding: '0.25rem',
                                    lineHeight: 1,
                                    transition: 'color 0.2s ease'
                                }}
                                onMouseEnter={(e) => e.target.style.color = 'rgba(0, 217, 255, 0.9)'}
                                onMouseLeave={(e) => e.target.style.color = 'rgba(255, 255, 255, 0.6)'}
                            >
                                √ó
                            </button>
                        </div>

                        {/* Scrollable Content */}
                        <div style={{
                            flex: 1,
                            overflowY: 'auto',
                            padding: '1.5rem'
                        }}>
                            {/* About the Blueprint */}
                            <div style={{ marginBottom: '2rem' }}>
                                <h4 style={{
                                    fontSize: '1rem',
                                    fontWeight: '600',
                                    color: 'rgba(0, 217, 255, 0.9)',
                                    margin: '0 0 0.75rem 0',
                                    letterSpacing: '0.02em'
                                }}>
                                    Discover Your Sonic Identity
                                </h4>
                                <p style={{
                                    fontSize: '0.875rem',
                                    color: 'rgba(255, 255, 255, 0.8)',
                                    margin: '0 0 1rem 0',
                                    lineHeight: '1.6'
                                }}>
                                    A creative system designed to help artists uncover and express their <strong style={{ color: 'rgba(0, 217, 255, 0.9)' }}>unique sonic identity</strong> using neuroscience, psychology, music, sound and creativity.
                                </p>
                                <button style={{
                                    padding: '0.625rem 1.25rem',
                                    background: 'rgba(0, 217, 255, 0.1)',
                                    border: '1px solid rgba(0, 217, 255, 0.3)',
                                    borderRadius: '8px',
                                    color: 'rgba(0, 217, 255, 0.9)',
                                    fontSize: '0.875rem',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s ease'
                                }}
                                onMouseEnter={(e) => {
                                    e.target.style.background = 'rgba(0, 217, 255, 0.15)';
                                    e.target.style.borderColor = 'rgba(0, 217, 255, 0.5)';
                                    e.target.style.boxShadow = '0 0 12px rgba(0, 217, 255, 0.3)';
                                }}
                                onMouseLeave={(e) => {
                                    e.target.style.background = 'rgba(0, 217, 255, 0.1)';
                                    e.target.style.borderColor = 'rgba(0, 217, 255, 0.3)';
                                    e.target.style.boxShadow = 'none';
                                }}>
                                    Explore the Framework
                                </button>
                            </div>

                            {/* Divider */}
                            <div style={{
                                height: '1px',
                                background: 'linear-gradient(to right, transparent, rgba(0, 217, 255, 0.3), transparent)',
                                margin: '1.5rem 0'
                            }}></div>

                            {/* Framework Insights Section */}
                            <div>
                                <h4 style={{
                                    fontSize: '0.875rem',
                                    fontWeight: '600',
                                    color: 'rgba(0, 217, 255, 0.8)',
                                    margin: '0 0 1rem 0',
                                    letterSpacing: '0.02em'
                                }}>
                                    Framework Insights
                                </h4>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                    {sources.map((source, idx) => {
                                        const similarityPercent = Math.round((source.similarity || 0) * 100);
                                        return (
                                            <div
                                                key={idx}
                                                style={{
                                                    padding: '1rem',
                                                    background: 'rgba(0, 217, 255, 0.06)',
                                                    border: '1px solid rgba(0, 217, 255, 0.15)',
                                                    borderRadius: '10px',
                                                    transition: 'all 0.2s ease'
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.currentTarget.style.background = 'rgba(0, 217, 255, 0.1)';
                                                    e.currentTarget.style.borderColor = 'rgba(0, 217, 255, 0.3)';
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.background = 'rgba(0, 217, 255, 0.06)';
                                                    e.currentTarget.style.borderColor = 'rgba(0, 217, 255, 0.15)';
                                                }}
                                            >
                                                <div style={{
                                                    display: 'flex',
                                                    alignItems: 'flex-start',
                                                    justifyContent: 'space-between',
                                                    gap: '0.75rem',
                                                    marginBottom: '0.5rem'
                                                }}>
                                                    <h5 style={{
                                                        fontSize: '0.875rem',
                                                        fontWeight: '600',
                                                        color: 'rgba(255, 255, 255, 0.9)',
                                                        margin: 0,
                                                        flex: 1
                                                    }}>
                                                        {source.page_title}
                                                    </h5>
                                                    <div style={{
                                                        fontSize: '0.75rem',
                                                        fontWeight: '600',
                                                        color: similarityPercent >= 90 ? 'rgba(0, 217, 255, 0.9)'
                                                            : similarityPercent >= 80 ? 'rgba(0, 217, 255, 0.7)'
                                                            : 'rgba(255, 255, 255, 0.6)',
                                                        padding: '0.25rem 0.5rem',
                                                        background: 'rgba(0, 217, 255, 0.15)',
                                                        borderRadius: '6px',
                                                        whiteSpace: 'nowrap'
                                                    }}>
                                                        {similarityPercent}%
                                                    </div>
                                                </div>
                                                {source.heading_path && (
                                                    <p style={{
                                                        fontSize: '0.75rem',
                                                        color: 'rgba(255, 255, 255, 0.5)',
                                                        margin: 0,
                                                        lineHeight: '1.4'
                                                    }}>
                                                        {source.heading_path}
                                                    </p>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                </>
            );
        }

        // Blueprint Trigger Bar - Compact bar that opens panel on hover
        function BlueprintSourceHoverSection({ sources, onOpenPanel, onClosePanel }) {
            const [isHovering, setIsHovering] = React.useState(false);

            if (!sources || sources.length === 0) return null;

            const handleMouseEnter = () => {
                setIsHovering(true);
                if (onOpenPanel) onOpenPanel();
            };

            const handleMouseLeave = () => {
                setIsHovering(false);
                // Don't close immediately - let the panel handle its own hover state
            };

            return (
                <div
                    style={{
                        marginBottom: '2rem',
                        paddingTop: '1rem',
                        position: 'relative'
                    }}
                    onMouseEnter={handleMouseEnter}
                    onMouseLeave={handleMouseLeave}
                >
                    {/* Compact Trigger Bar */}
                    <div
                        style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.75rem',
                            padding: '0.75rem 1rem',
                            background: isHovering ? 'rgba(0, 217, 255, 0.1)' : 'rgba(0, 217, 255, 0.05)',
                            border: `1px solid ${isHovering ? 'rgba(0, 217, 255, 0.3)' : 'rgba(0, 217, 255, 0.15)'}`,
                            borderRadius: '12px',
                            cursor: 'pointer',
                            transition: 'all 0.3s ease',
                            boxShadow: isHovering ? '0 0 16px rgba(0, 217, 255, 0.2)' : 'none'
                        }}
                    >
                        <span style={{ fontSize: '1rem', opacity: 0.8 }}>üìò</span>
                        <div style={{ flex: 1 }}>
                            <p style={{
                                fontSize: '0.875rem',
                                fontWeight: '500',
                                color: 'rgba(255, 255, 255, 0.9)',
                                margin: 0,
                                letterSpacing: '0.01em'
                            }}>
                                This message contains information about the Neural Music Blueprint
                            </p>
                        </div>
                        <span style={{
                            fontSize: '0.875rem',
                            color: 'rgba(0, 217, 255, 0.7)',
                            transition: 'transform 0.3s ease'
                        }}>
                            ‚Üí
                        </span>
                    </div>

                    {/* Hover Preview Tooltip */}
                    {isHovering && (
                        <div style={{
                            position: 'absolute',
                            top: '-3rem',
                            left: '50%',
                            transform: 'translateX(-50%)',
                            padding: '0.625rem 1rem',
                            background: 'rgba(10, 10, 31, 0.98)',
                            backdropFilter: 'blur(20px)',
                            border: '1px solid rgba(0, 217, 255, 0.4)',
                            borderRadius: '8px',
                            boxShadow: '0 8px 24px rgba(0, 0, 0, 0.4), 0 0 16px rgba(0, 217, 255, 0.2)',
                            zIndex: 100,
                            whiteSpace: 'nowrap',
                            animation: 'fadeIn 0.2s ease'
                        }}>
                            <p style={{
                                margin: 0,
                                fontSize: '0.8125rem',
                                color: 'rgba(0, 217, 255, 0.9)',
                                fontWeight: '500',
                                fontStyle: 'italic'
                            }}>
                                Hover to explore ‚Ä¢ Uncover your unique sonic identity
                            </p>
                            {/* Arrow */}
                            <div style={{
                                position: 'absolute',
                                bottom: '-6px',
                                left: '50%',
                                transform: 'translateX(-50%)',
                                width: 0,
                                height: 0,
                                borderLeft: '6px solid transparent',
                                borderRight: '6px solid transparent',
                                borderTop: '6px solid rgba(0, 217, 255, 0.4)'
                            }}></div>
                        </div>
                    )}
                </div>
            );
        }

        // Blueprint Source Component - Simplified (no longer used inline, kept for compatibility)
        function BlueprintSourceCard({ source, index }) {
            const similarityPercent = Math.round((source.similarity || 0) * 100);

            return (
                <div style={{
                    background: 'rgba(0, 217, 255, 0.04)',
                    border: '1px solid rgba(0, 217, 255, 0.12)',
                    borderRadius: '12px',
                    padding: '1rem',
                    marginBottom: '0.75rem'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.25rem' }}>
                        <span style={{ fontSize: '0.875rem', opacity: 0.6 }}>üìò</span>
                        <h5 style={{
                            fontSize: '0.875rem',
                            fontWeight: '600',
                            color: 'rgba(0, 217, 255, 0.9)',
                            margin: 0
                        }}>
                            {source.page_title}
                        </h5>
                        <div style={{
                            fontSize: '0.75rem',
                            fontWeight: '600',
                            color: similarityPercent >= 90 ? 'rgba(0, 217, 255, 0.9)'
                                : similarityPercent >= 80 ? 'rgba(0, 150, 255, 0.8)'
                                : 'rgba(255, 255, 255, 0.6)',
                            padding: '0.25rem 0.5rem',
                            background: similarityPercent >= 90 ? 'rgba(0, 217, 255, 0.1)'
                                : 'rgba(255, 255, 255, 0.05)',
                            borderRadius: '6px',
                            marginLeft: 'auto'
                        }}>
                            {similarityPercent}%
                        </div>
                    </div>
                    {source.heading_path && (
                        <p style={{
                            fontSize: '0.75rem',
                            color: 'rgba(255, 255, 255, 0.5)',
                            margin: '0.25rem 0 0 1.25rem'
                        }}>
                            {source.heading_path}
                        </p>
                    )}
                </div>
            );
        }

        // Source Card Component - Display individual research source
        function SourceCard({ source, index }) {
            // Tier colors (matches evidence hierarchy)
            const tierColors = {
                1: '#9333EA',  // Purple - Meta-Analysis/Systematic Review
                2: '#3B82F6',  // Blue - RCT
                3: '#10B981',  // Green - Observational
                4: '#F59E0B',  // Yellow - Case Study
                5: '#6B7280'   // Gray - Opinion/Limited Evidence
            };

            const tierColor = tierColors[source.credibility?.tier_number] || '#6B7280';
            const isScientific = source.source_type === 'scientific';

            return (
                <div className="source-card mb-4 p-5 rounded-xl glass-card border border-primary/20" style={{
                    background: 'rgba(10, 10, 20, 0.6)',
                    transition: 'all 0.3s ease'
                }}>
                    {/* Header */}
                    <div className="flex items-start gap-3 mb-3">
                        <span className="flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold"
                            style={{ background: `${tierColor}20`, color: tierColor, border: `1px solid ${tierColor}` }}>
                            {index}
                        </span>
                        <div className="flex-1">
                            <h4 className="text-white font-semibold text-sm leading-tight mb-2">{source.title}</h4>
                            <span className="inline-block px-2 py-1 rounded text-xs font-semibold"
                                style={{ background: `${tierColor}20`, color: tierColor }}>
                                {source.credibility?.tier || 'Unknown Tier'}
                            </span>
                        </div>
                    </div>

                    {/* Metadata */}
                    <div className="text-xs text-gray-400 mb-3 flex flex-wrap gap-2">
                        {isScientific ? (
                            <>
                                {source.authors && <span>{source.authors}</span>}
                                {source.journal && source.year && (
                                    <span>‚Ä¢ {source.journal}, {source.year}</span>
                                )}
                                {source.cited_by_count && (
                                    <span>‚Ä¢ {source.cited_by_count} citations</span>
                                )}
                                {source.is_open_access && (
                                    <span className="text-green-400">‚Ä¢ Open Access</span>
                                )}
                            </>
                        ) : (
                            <>
                                {source.source && <span>{source.source}</span>}
                                {source.published_date && <span>‚Ä¢ {source.published_date}</span>}
                            </>
                        )}
                    </div>

                    {/* Key Finding */}
                    {source.key_finding && (
                        <p className="text-gray-300 text-sm leading-relaxed mb-4 italic border-l-2 border-primary/30 pl-3">
                            {source.key_finding}
                        </p>
                    )}

                    {/* Footer */}
                    <div className="flex items-center justify-between">
                        {/* Credibility Score */}
                        <div className="flex items-center gap-2">
                            <span className="text-xs text-gray-500">Credibility:</span>
                            <div className="w-24 h-2 bg-gray-800 rounded-full overflow-hidden">
                                <div className="h-full rounded-full transition-all duration-500"
                                    style={{
                                        width: `${source.credibility?.score || 0}%`,
                                        background: `linear-gradient(90deg, ${tierColor}, ${tierColor}cc)`
                                    }}
                                />
                            </div>
                            <span className="text-xs font-semibold" style={{ color: tierColor }}>
                                {source.credibility?.score || 0}/100
                            </span>
                        </div>

                        {/* Read Link */}
                        <a href={source.url} target="_blank" rel="noopener noreferrer"
                            className="text-xs font-semibold text-primary hover:text-primary-light transition-colors flex items-center gap-1">
                            {isScientific ? (source.is_open_access ? 'Read (Open Access)' : 'Read Paper') : 'Read Article'}
                            <span>‚Üí</span>
                        </a>
                    </div>
                </div>
            );
        }

        // Research Quality Badge - Shows Pro tier research depth
        function ResearchQualityBadge({ research_quality }) {
            if (!research_quality || !research_quality.data_points) return null;

            const { data_points, results_sections, total_papers, research_depth } = research_quality;

            // Depth indicator
            const depthLabels = {
                'results': 'Results Sections',
                'full_text': 'Full-Text Analysis',
                'abstract': 'Abstract Analysis'
            };

            return (
                <div className="research-quality-badge mb-4 px-4 py-3 rounded-xl border border-green-500/30 bg-green-500/10 flex items-start gap-3">
                    <svg className="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                    </svg>
                    <div className="flex-1">
                        <p className="text-green-300 text-sm font-semibold mb-1">
                            Deep Research Analysis
                        </p>
                        <p className="text-green-200/80 text-xs leading-relaxed">
                            Found <span className="font-bold text-green-300">{data_points}</span> quantitative findings from{' '}
                            <span className="font-bold text-green-300">{results_sections || total_papers}</span> peer-reviewed papers
                            {research_depth === 'results' && ' (Results sections analyzed)'}
                        </p>
                    </div>
                    <span className="px-2 py-1 rounded-md bg-green-600/30 text-green-300 text-xs font-bold uppercase tracking-wide">
                        Pro
                    </span>
                </div>
            );
        }

        // Citation Marker Component - Inline [N] with hover tooltip
        function CitationMarker({ number, reference }) {
            const [showTooltip, setShowTooltip] = useState(false);
            const markerRef = useRef(null);

            if (!reference) return <span>[{number}]</span>;

            return (
                <span className="citation-wrapper" style={{ position: 'relative', display: 'inline' }}>
                    <a
                        ref={markerRef}
                        href={reference.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="citation-marker"
                        onMouseEnter={() => setShowTooltip(true)}
                        onMouseLeave={() => setShowTooltip(false)}
                        style={{
                            color: '#3B82F6',
                            textDecoration: 'none',
                            fontSize: '0.85em',
                            verticalAlign: 'super',
                            fontWeight: '600',
                            cursor: 'pointer',
                            transition: 'color 0.2s'
                        }}
                        onMouseOver={(e) => e.currentTarget.style.color = '#2563EB'}
                        onMouseOut={(e) => e.currentTarget.style.color = '#3B82F6'}
                    >
                        [{number}]
                    </a>

                    {/* Tooltip */}
                    {showTooltip && (
                        <div className="citation-tooltip" style={{
                            position: 'absolute',
                            bottom: '100%',
                            left: '50%',
                            transform: 'translateX(-50%) translateY(-8px)',
                            width: '320px',
                            padding: '12px 16px',
                            background: 'rgba(15, 23, 42, 0.98)',
                            border: '1px solid rgba(59, 130, 246, 0.3)',
                            borderRadius: '12px',
                            boxShadow: '0 8px 24px rgba(0, 0, 0, 0.5)',
                            zIndex: 9999,
                            animation: 'fadeIn 0.2s ease',
                            pointerEvents: 'none'
                        }}>
                            {/* Arrow */}
                            <div style={{
                                position: 'absolute',
                                bottom: '-6px',
                                left: '50%',
                                transform: 'translateX(-50%)',
                                width: '12px',
                                height: '12px',
                                background: 'rgba(15, 23, 42, 0.98)',
                                border: '1px solid rgba(59, 130, 246, 0.3)',
                                borderTop: 'none',
                                borderLeft: 'none',
                                transform: 'translateX(-50%) rotate(45deg)'
                            }} />

                            <h4 className="text-white font-semibold text-sm mb-2 leading-tight">
                                {reference.title}
                            </h4>

                            <p className="text-gray-300 text-xs mb-2">
                                {reference.authors} ({reference.year})
                            </p>

                            {reference.credibility_score && (
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="text-xs text-gray-400">Credibility:</span>
                                    <span className="text-xs font-bold" style={{
                                        color: reference.credibility_score >= 80 ? '#10B981' :
                                               reference.credibility_score >= 60 ? '#3B82F6' : '#F59E0B'
                                    }}>
                                        {reference.credibility_score}/100
                                    </span>
                                    {reference.credibility_grade && (
                                        <span className="text-xs text-gray-400">
                                            (Grade {reference.credibility_grade})
                                        </span>
                                    )}
                                </div>
                            )}

                            <p className="text-gray-400 text-xs mb-2">
                                {reference.study_type && <span>{reference.study_type}</span>}
                                {reference.journal && <span> ¬∑ {reference.journal}</span>}
                            </p>

                            <div className="text-xs text-primary font-semibold flex items-center gap-1">
                                Click to read paper <span>‚Üí</span>
                            </div>
                        </div>
                    )}
                </span>
            );
        }

        // Parse text and render inline citations
        function TextWithCitations({ text, cited_references }) {
            if (!text || !cited_references || Object.keys(cited_references).length === 0) {
                return <>{text}</>;
            }

            // Split text by [N] pattern while keeping the markers
            const parts = text.split(/(\[\d+\])/g);

            return (
                <>
                    {parts.map((part, index) => {
                        const match = part.match(/\[(\d+)\]/);
                        if (match) {
                            const num = parseInt(match[1]);
                            // cited_references is now an object keyed by number: {"1": {...}, "2": {...}}
                            const ref = cited_references[String(num)] || cited_references[num];
                            return <CitationMarker key={index} number={num} reference={ref} />;
                        }
                        return <span key={index}>{part}</span>;
                    })}
                </>
            );
        }

        // Evidence in the Pattern - Professional liquid glass research section
        function EvidenceInThePattern({ research_synthesis, cited_references }) {
            if (!research_synthesis) return null;

            return (
                <div className="evidence-section mt-6" style={{
                    background: 'rgba(10, 10, 31, 0.4)',
                    backdropFilter: 'blur(24px)',
                    WebkitBackdropFilter: 'blur(24px)',
                    border: '1px solid rgba(0, 217, 255, 0.12)',
                    borderRadius: '16px',
                    padding: '1.75rem',
                    boxShadow: '0 0 25px rgba(0, 191, 255, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.03)',
                    position: 'relative'
                }}>
                    {/* Heading */}
                    <div className="flex items-center gap-3 mb-4" style={{
                        paddingBottom: '0.75rem',
                        borderBottom: '1px solid rgba(0, 217, 255, 0.08)'
                    }}>
                        <span style={{
                            fontSize: '1.25rem',
                            filter: 'drop-shadow(0 0 8px rgba(0, 217, 255, 0.4))'
                        }}>üî¨</span>
                        <h3 className="text-white font-semibold" style={{
                            fontSize: '1rem',
                            letterSpacing: '0.03em',
                            textTransform: 'uppercase',
                            color: 'rgba(0, 217, 255, 0.95)',
                            fontWeight: '600'
                        }}>
                            Evidence in the Pattern
                        </h3>
                    </div>

                    {/* Research Content with Citations */}
                    <div className="text-white leading-relaxed" style={{
                        fontSize: '0.95rem',
                        lineHeight: '1.8',
                        color: 'rgba(255, 255, 255, 0.9)'
                    }}>
                        <TextWithCitations
                            text={research_synthesis}
                            cited_references={cited_references}
                        />
                    </div>
                </div>
            );
        }

        // Highlighted Question Component - Beautiful prominent question display
        function HighlightedQuestion({ question }) {
            if (!question) return null;

            return (
                <div className="highlighted-question mt-6" style={{
                    background: 'linear-gradient(135deg, rgba(0, 13, 255, 0.08) 0%, rgba(0, 217, 255, 0.08) 100%)',
                    backdropFilter: 'blur(24px)',
                    WebkitBackdropFilter: 'blur(24px)',
                    border: '2px solid rgba(0, 217, 255, 0.3)',
                    borderRadius: '20px',
                    padding: '2rem',
                    boxShadow: '0 0 40px rgba(0, 191, 255, 0.2), inset 0 2px 0 rgba(255, 255, 255, 0.05)',
                    animation: 'subtle-pulse 3s ease-in-out infinite',
                    position: 'relative'
                }}>
                    {/* Icon */}
                    <div style={{
                        textAlign: 'center',
                        marginBottom: '1.25rem'
                    }}>
                        <span style={{
                            fontSize: '2rem',
                            filter: 'drop-shadow(0 0 12px rgba(0, 217, 255, 0.5))'
                        }}>üí≠</span>
                    </div>

                    {/* Question Text */}
                    <p className="text-white text-center" style={{
                        fontSize: '1.15rem',
                        lineHeight: '1.8',
                        fontWeight: '500',
                        color: 'rgba(255, 255, 255, 0.95)',
                        letterSpacing: '0.01em'
                    }}>
                        {question}
                    </p>
                </div>
            );
        }

        // User Response Area - Inline textarea and submit
        function UserResponseArea({ onSubmit, messageId }) {
            const [response, setResponse] = useState('');
            const [submitting, setSubmitting] = useState(false);

            const handleSubmit = async () => {
                if (!response.trim()) return;
                setSubmitting(true);
                await onSubmit(response);
                setResponse('');
                setSubmitting(false);
            };

            return (
                <div className="user-response-area mt-6">
                    {/* Textarea */}
                    <textarea
                        value={response}
                        onChange={(e) => setResponse(e.target.value)}
                        placeholder="Share your reflection..."
                        className="w-full px-4 py-3 rounded-xl resize-none"
                        rows={4}
                        style={{
                            background: 'rgba(10, 10, 31, 0.5)',
                            backdropFilter: 'blur(12px)',
                            WebkitBackdropFilter: 'blur(12px)',
                            border: '1px solid rgba(0, 217, 255, 0.2)',
                            color: 'white',
                            fontSize: '0.95rem',
                            lineHeight: '1.6',
                            outline: 'none',
                            transition: 'all 0.3s ease'
                        }}
                        onFocus={(e) => {
                            e.target.style.border = '1px solid rgba(0, 217, 255, 0.4)';
                            e.target.style.boxShadow = '0 0 20px rgba(0, 191, 255, 0.2)';
                        }}
                        onBlur={(e) => {
                            e.target.style.border = '1px solid rgba(0, 217, 255, 0.2)';
                            e.target.style.boxShadow = 'none';
                        }}
                    />

                    {/* Submit Button */}
                    <button
                        onClick={handleSubmit}
                        disabled={!response.trim() || submitting}
                        className="btn-sci-fi mt-4 px-8 py-3 rounded-xl font-semibold"
                        style={{
                            opacity: !response.trim() || submitting ? 0.5 : 1,
                            cursor: !response.trim() || submitting ? 'not-allowed' : 'pointer'
                        }}
                    >
                        {submitting ? 'Sending...' : 'Continue Journey ‚Üí'}
                    </button>
                </div>
            );
        }

        // Sources Section Component - Collapsible list of sources
        function SourcesSection({ sources }) {
            const [showSources, setShowSources] = useState(false);

            if (!sources || sources.length === 0) return null;

            return (
                <div className="sources-section mt-6">
                    {/* Toggle Button */}
                    <button
                        onClick={() => setShowSources(!showSources)}
                        className="w-full py-3 px-5 rounded-xl border border-primary/30 bg-primary/10 hover:bg-primary/20 transition-all duration-300 flex items-center justify-between group"
                    >
                        <div className="flex items-center gap-3">
                            <span className="text-xl">üìö</span>
                            <span className="text-white font-semibold">
                                {showSources ? 'Hide' : 'View'} Full References
                            </span>
                            <span className="px-2 py-1 rounded-full bg-primary/30 text-primary text-xs font-bold">
                                {sources.length}
                            </span>
                        </div>
                        <span className="text-primary transform transition-transform duration-300"
                            style={{ transform: showSources ? 'rotate(180deg)' : 'rotate(0deg)' }}>
                            ‚ñº
                        </span>
                    </button>

                    {/* Sources List */}
                    {showSources && (
                        <div className="mt-4 space-y-3" style={{
                            animation: 'slideUp 0.5s cubic-bezier(0.22, 1, 0.36, 1)'
                        }}>
                            {sources.map((source, i) => (
                                <SourceCard key={source.id || i} source={source} index={i + 1} />
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // References Sidebar - Right sliding panel (OpenAI thinking mode style)
        function ReferencesSidebar({ isOpen, onClose, sources }) {
            if (!sources || sources.length === 0) return null;

            return (
                <>
                    {/* Backdrop */}
                    {isOpen && (
                        <div
                            onClick={onClose}
                            style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                background: 'rgba(0, 0, 0, 0.4)',
                                backdropFilter: 'blur(4px)',
                                WebkitBackdropFilter: 'blur(4px)',
                                zIndex: 999,
                                opacity: isOpen ? 1 : 0,
                                transition: 'opacity 0.3s ease'
                            }}
                        />
                    )}

                    {/* Sidebar Panel */}
                    <div style={{
                        position: 'fixed',
                        right: isOpen ? 0 : '-420px',
                        top: 0,
                        width: '420px',
                        height: '100vh',
                        background: 'rgba(10, 10, 31, 0.95)',
                        backdropFilter: 'blur(40px)',
                        WebkitBackdropFilter: 'blur(40px)',
                        borderLeft: '1px solid rgba(0, 217, 255, 0.2)',
                        boxShadow: '-10px 0 50px rgba(0, 0, 0, 0.5)',
                        transition: 'right 0.3s cubic-bezier(0.22, 1, 0.36, 1)',
                        zIndex: 1000,
                        display: 'flex',
                        flexDirection: 'column',
                        overflow: 'hidden'
                    }}>
                        {/* Header */}
                        <div style={{
                            padding: '1.5rem',
                            borderBottom: '1px solid rgba(0, 217, 255, 0.1)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            background: 'rgba(0, 13, 255, 0.05)'
                        }}>
                            <div className="flex items-center gap-3">
                                <span style={{
                                    fontSize: '1.5rem',
                                    filter: 'drop-shadow(0 0 8px rgba(0, 217, 255, 0.4))'
                                }}>üìö</span>
                                <h3 className="text-white font-semibold" style={{
                                    fontSize: '1.1rem',
                                    letterSpacing: '0.02em'
                                }}>
                                    Full References
                                </h3>
                                <span className="px-2 py-1 rounded-full text-xs font-bold" style={{
                                    background: 'rgba(0, 217, 255, 0.2)',
                                    color: 'rgba(0, 217, 255, 0.95)'
                                }}>
                                    {sources.length}
                                </span>
                            </div>
                            <button
                                onClick={onClose}
                                className="text-white hover:text-primary transition-colors"
                                style={{
                                    fontSize: '1.5rem',
                                    background: 'none',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '0.25rem'
                                }}
                            >
                                √ó
                            </button>
                        </div>

                        {/* Scrollable Content */}
                        <div style={{
                            flex: 1,
                            overflowY: 'auto',
                            padding: '1.5rem',
                            scrollbarWidth: 'thin',
                            scrollbarColor: '#00A8FF #1a1a1a'
                        }}>
                            <div className="space-y-4">
                                {sources.map((source, i) => (
                                    <SourceCard key={source.id || i} source={source} index={i + 1} />
                                ))}
                            </div>
                        </div>
                    </div>
                </>
            );
        }

        // Dialogue Modal Component
        function DialogueModal({ dialogue, onClose, onSendResponse }) {
            const [showQuestion, setShowQuestion] = useState(false);
            const [userResponse, setUserResponse] = useState('');
            const textareaRef = useRef(null);

            if (!dialogue) return null;

            const handleContinue = () => {
                setShowQuestion(true);
                // Auto-focus textarea after animation
                setTimeout(() => textareaRef.current?.focus(), 600);
            };

            const handleSubmit = () => {
                if (userResponse.trim()) {
                    onSendResponse(userResponse.trim());
                    onClose();
                }
            };

            return (
                <div className="dialogue-modal-overlay" onClick={onClose}>
                    <div className="dialogue-modal" onClick={(e) => e.stopPropagation()} style={{
                        transition: 'all 0.3s ease',
                        maxWidth: showQuestion ? '800px' : '700px'
                    }}>
                        {/* Close Button */}
                        <button className="dialogue-modal-close" onClick={onClose}>
                            ‚úï
                        </button>

                        {/* Guidance - Minimizes when question appears */}
                        <div style={{
                            transition: 'all 0.5s ease',
                            marginBottom: showQuestion ? '1.5rem' : '2.5rem',
                            opacity: showQuestion ? 0.7 : 1,
                            transform: showQuestion ? 'scale(0.95)' : 'scale(1)'
                        }}>
                            {/* Header */}
                            <div style={{ marginBottom: showQuestion ? '1rem' : '2.5rem', textAlign: 'center' }}>
                                <div style={{
                                    fontSize: showQuestion ? '2rem' : '3rem',
                                    marginBottom: '0.5rem',
                                    filter: 'drop-shadow(0 0 20px rgba(0, 191, 255, 0.6))',
                                    transition: 'all 0.5s ease'
                                }}>
                                    üß†
                                </div>
                                <h2 className="text-white glow" style={{
                                    fontSize: showQuestion ? '1.5rem' : '2rem',
                                    fontWeight: 900,
                                    marginBottom: '0.5rem',
                                    letterSpacing: '0.02em',
                                    transition: 'all 0.5s ease'
                                }}>
                                    {!showQuestion ? 'Understanding Your Process' : 'Your Creative Reflection'}
                                </h2>
                                {!showQuestion && (
                                    <p className="text-primary text-sm font-medium">
                                        Knowledge Digestion
                                    </p>
                                )}
                            </div>

                            {/* Guidance Text */}
                            <div
                                className="text-white leading-relaxed"
                                style={{
                                    fontSize: showQuestion ? '0.95rem' : '1.15rem',
                                    lineHeight: showQuestion ? '1.6' : '2',
                                    padding: showQuestion ? '1rem' : '1.5rem',
                                    background: 'rgba(0, 191, 255, 0.03)',
                                    borderRadius: '16px',
                                    border: '1px solid rgba(0, 191, 255, 0.1)',
                                    transition: 'all 0.5s ease',
                                    marginBottom: showQuestion ? '0' : '2rem'
                                }}>
                                <TextWithCitations
                                    text={dialogue.guidance}
                                    cited_references={dialogue.cited_references}
                                />
                            </div>
                        </div>

                        {/* Continue Button */}
                        {dialogue.reflective_question && !showQuestion && (
                            <div style={{ textAlign: 'center' }}>
                                <button
                                    onClick={handleContinue}
                                    className="btn-sci-fi px-10 py-5 rounded-2xl font-bold text-white"
                                    style={{
                                        fontSize: '1.1rem',
                                        letterSpacing: '0.05em',
                                        position: 'relative',
                                        zIndex: 10
                                    }}>
                                    REFLECT DEEPER ‚Üí
                                </button>
                                <p className="text-gray-400 text-xs mt-3">Click to explore your creative patterns</p>
                            </div>
                        )}

                        {/* Question + Input Section - Appears prominently */}
                        {dialogue.reflective_question && showQuestion && (
                            <div style={{
                                animation: 'slideUp 0.6s ease',
                                marginTop: '2rem'
                            }}>
                                {/* Question Box - Center Stage */}
                                <div
                                    className="p-8 rounded-2xl"
                                    style={{
                                        background: 'linear-gradient(135deg, rgba(0, 191, 255, 0.15) 0%, rgba(30, 144, 255, 0.15) 100%)',
                                        border: '2px solid rgba(0, 191, 255, 0.3)',
                                        boxShadow: '0 0 40px rgba(0, 191, 255, 0.3)',
                                        position: 'relative',
                                        overflow: 'hidden',
                                        marginBottom: '1.5rem'
                                    }}>
                                    <div style={{
                                        position: 'absolute',
                                        top: 0,
                                        left: 0,
                                        width: '4px',
                                        height: '100%',
                                        background: 'linear-gradient(180deg, #000DFF 0%, #001AFF 100%)',
                                        boxShadow: '0 0 20px rgba(0, 191, 255, 0.8)'
                                    }}></div>

                                    <div style={{ paddingLeft: '1rem' }}>
                                        <p className="text-primary text-xs font-bold uppercase tracking-wider mb-4 glow" style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '0.5rem'
                                        }}>
                                            <span>üí≠</span> A Question For You
                                        </p>
                                        <p className="text-white leading-relaxed" style={{
                                            fontSize: '1.3rem',
                                            lineHeight: '2',
                                            fontWeight: '500'
                                        }}>
                                            {dialogue.reflective_question}
                                        </p>
                                    </div>
                                </div>

                                {/* Input Area - For User Response */}
                                <div>
                                    <label className="text-gray-300 text-sm mb-2 block">
                                        Share your thoughts or continue the conversation:
                                    </label>
                                    <textarea
                                        ref={textareaRef}
                                        value={userResponse}
                                        onChange={(e) => setUserResponse(e.target.value)}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter' && !e.shiftKey) {
                                                e.preventDefault();
                                                handleSubmit();
                                            }
                                        }}
                                        placeholder="Type your response or what's on your mind..."
                                        className="w-full px-5 py-4 bg-black/40 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 resize-none"
                                        rows="4"
                                        style={{
                                            fontSize: '1.05rem',
                                            lineHeight: '1.6'
                                        }}
                                    />
                                    <div style={{ display: 'flex', gap: '1rem', marginTop: '1rem', justifyContent: 'flex-end' }}>
                                        <button
                                            onClick={onClose}
                                            className="px-6 py-3 rounded-xl font-medium text-gray-400 hover:text-white transition-all"
                                            style={{
                                                border: '1px solid rgba(156, 163, 175, 0.3)'
                                            }}>
                                            Close
                                        </button>
                                        <button
                                            onClick={handleSubmit}
                                            disabled={!userResponse.trim()}
                                            className="btn-sci-fi px-8 py-3 rounded-xl font-semibold text-white disabled:opacity-40 disabled:cursor-not-allowed"
                                            style={{ position: 'relative', zIndex: 10 }}>
                                            Send Response
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Research Quality Badge - Shows Pro tier depth */}
                        <ResearchQualityBadge research_quality={dialogue.research_quality} />

                        {/* Research Sources Section */}
                        <SourcesSection sources={dialogue.sources} />
                    </div>
                </div>
            );
        }

        // Dialogue Message Component (for chat history display)
        function DialogueMessage({ message, onOpenDialogue, onOpenReferences, onOpenBlueprintPanel, onCloseBlueprintPanel, sendMessage }) {
            if (message.role === 'user') {
                // User message (simple)
                return (
                    <div className="message flex justify-end">
                        <div className="max-w-[70%] rounded-2xl px-6 py-4 bg-gradient-to-r from-primary/30 to-primary-dark/30 border border-primary/50">
                            <p className="text-xs font-semibold text-primary uppercase tracking-wide mb-2">You</p>
                            <p className="text-white leading-relaxed">{message.content}</p>
                        </div>
                    </div>
                );
            }

            // Auron message (streaming) - Simple text display while typing
            if (message.isStreaming) {
                return (
                    <div className="message flex justify-start">
                        <div style={{
                            maxWidth: '85%',
                            background: 'rgba(255, 255, 255, 0.02)',
                            backdropFilter: 'blur(20px)',
                            WebkitBackdropFilter: 'blur(20px)',
                            border: '1px solid rgba(255, 255, 255, 0.06)',
                            borderRadius: '20px',
                            padding: '1.75rem 2rem',
                            boxShadow: '0 4px 16px rgba(0, 0, 0, 0.3)'
                        }}>
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.625rem',
                                marginBottom: '1rem'
                            }}>
                                <span style={{
                                    fontSize: '1.25rem'
                                }}>üß†</span>
                                <p style={{
                                    fontSize: '0.75rem',
                                    fontWeight: '600',
                                    color: '#00D9FF',
                                    textTransform: 'uppercase',
                                    letterSpacing: '0.1em',
                                    margin: 0
                                }}>AURON</p>
                            </div>
                            <div style={{
                                color: 'rgba(255, 255, 255, 0.85)',
                                lineHeight: '1.75',
                                fontSize: '1.05rem',
                                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
                            }}>
                                {message.guidance}
                                <span style={{
                                    display: 'inline-block',
                                    width: '2px',
                                    height: '1.2em',
                                    background: '#00D9FF',
                                    marginLeft: '2px',
                                    animation: 'blink 1s step-end infinite',
                                    verticalAlign: 'text-bottom'
                                }} />
                            </div>
                        </div>
                    </div>
                );
            }

            // Auron message (dialogue with inline research) - FLOWING NATURAL LAYOUT
            if (message.isDialogue) {
                // Parse guidance to extract reflection question if embedded
                let guidance = message.dialogue.guidance || '';
                let reflectiveQuestion = message.dialogue.reflective_question;

                const reflectionMatch = guidance.match(/REFLECTION QUESTION:\s*(.+?)$/s);
                if (reflectionMatch) {
                    reflectiveQuestion = reflectionMatch[1].trim();
                    guidance = guidance.replace(/REFLECTION QUESTION:\s*.+$/s, '').trim();
                }

                return (
                    <div className="message flex justify-start">
                        <div style={{
                            maxWidth: '85%',
                            width: '100%',
                            borderRadius: '20px',
                            padding: '2rem',
                            background: 'rgba(10, 10, 31, 0.3)',
                            backdropFilter: 'blur(20px)',
                            WebkitBackdropFilter: 'blur(20px)',
                            border: '1px solid rgba(0, 217, 255, 0.1)',
                            boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)'
                        }}>
                            {/* Header */}
                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '1.5rem' }}>
                                <span style={{
                                    fontSize: '1.75rem',
                                    filter: 'drop-shadow(0 0 8px rgba(0, 217, 255, 0.4))'
                                }}>üß†</span>
                                <div>
                                    <p className="text-xs font-semibold uppercase tracking-wide glow" style={{
                                        color: 'rgba(0, 217, 255, 0.95)',
                                        letterSpacing: '0.1em'
                                    }}>
                                        Auron
                                    </p>
                                </div>
                            </div>

                            {/* Guidance Text - Flowing naturally */}
                            <div className="text-white leading-relaxed" style={{
                                fontSize: '1.05rem',
                                lineHeight: '1.8',
                                color: 'rgba(255, 255, 255, 0.95)',
                                marginBottom: message.dialogue.research_synthesis ? '1.5rem' : '2rem'
                            }}>
                                <TextWithCitations
                                    text={guidance}
                                    cited_references={message.dialogue.cited_references}
                                />
                            </div>

                            {/* Blueprint Sources - Hover to expand section below text */}
                            <BlueprintSourceHoverSection
                                sources={message.dialogue.blueprint_sources}
                                onOpenPanel={() => onOpenBlueprintPanel(message.dialogue.blueprint_sources || [])}
                                onClosePanel={onCloseBlueprintPanel}
                            />

                            {/* Evidence in the Pattern - Subtle, flowing integration */}
                            {message.dialogue.research_synthesis && (
                                <div style={{
                                    marginBottom: '2rem',
                                    paddingTop: '1.5rem',
                                    borderTop: '1px solid rgba(0, 217, 255, 0.08)'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '0.5rem',
                                        marginBottom: '1rem'
                                    }}>
                                        <span style={{ fontSize: '1rem', opacity: 0.7 }}>üî¨</span>
                                        <h4 className="text-white" style={{
                                            fontSize: '0.85rem',
                                            letterSpacing: '0.05em',
                                            textTransform: 'uppercase',
                                            color: 'rgba(0, 217, 255, 0.7)',
                                            fontWeight: '600'
                                        }}>
                                            Evidence in the Pattern
                                        </h4>
                                    </div>
                                    <div className="text-white leading-relaxed" style={{
                                        fontSize: '0.95rem',
                                        lineHeight: '1.8',
                                        color: 'rgba(255, 255, 255, 0.85)',
                                        paddingLeft: '1.5rem'
                                    }}>
                                        <TextWithCitations
                                            text={message.dialogue.research_synthesis}
                                            cited_references={message.dialogue.cited_references}
                                        />
                                    </div>
                                </div>
                            )}

                            {/* Reflective Question - Natural continuation */}
                            {reflectiveQuestion && (
                                <div style={{
                                    marginTop: '2rem',
                                    paddingTop: '2rem',
                                    borderTop: '1px solid rgba(0, 217, 255, 0.15)'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '0.75rem',
                                        marginBottom: '1rem'
                                    }}>
                                        <span style={{
                                            fontSize: '1.5rem',
                                            filter: 'drop-shadow(0 0 8px rgba(0, 217, 255, 0.3))'
                                        }}>üí≠</span>
                                        <p className="text-white" style={{
                                            fontSize: '1.1rem',
                                            lineHeight: '1.6',
                                            fontWeight: '500',
                                            color: 'rgba(255, 255, 255, 0.95)',
                                            fontStyle: 'italic'
                                        }}>
                                            {reflectiveQuestion}
                                        </p>
                                    </div>

                                    {/* User Response Area */}
                                    <UserResponseArea
                                        onSubmit={async (response) => {
                                            await sendMessage(response);
                                        }}
                                        messageId={message.dialogue.session_id}
                                    />
                                </div>
                            )}

                            {/* View Full References - Subtle link */}
                            {message.dialogue.sources && message.dialogue.sources.length > 0 && (
                                <button
                                    onClick={() => onOpenReferences(message.dialogue.sources)}
                                    className="mt-6 text-sm flex items-center gap-2 text-white/60 hover:text-white/90 transition-colors mx-auto"
                                    style={{
                                        background: 'none',
                                        border: 'none',
                                        cursor: 'pointer',
                                        textDecoration: 'underline',
                                        textUnderlineOffset: '4px'
                                    }}
                                >
                                    <span style={{ fontSize: '1rem' }}>üìö</span>
                                    View Full References ({message.dialogue.sources.length})
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            // Regular Auron message (e.g., welcome message)
            return (
                <div className="message flex justify-start">
                    <div className="max-w-[75%] rounded-2xl px-6 py-5 bg-gray-900 border border-gray-800">
                        <p className="text-xs font-semibold text-primary uppercase tracking-wide mb-3 glow">
                            Auron
                        </p>
                        <p className="text-white leading-relaxed" style={{ lineHeight: '1.7' }}>
                            {message.content}
                        </p>
                    </div>
                </div>
            );
        }

        // Reflections View - Horizontal scrolling card gallery
        function ReflectionsView({ user, setCurrentView, setLoadedSessionId }) {
            const [conversations, setConversations] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedConversation, setSelectedConversation] = useState(null);
            const [conversationDetails, setConversationDetails] = useState(null);
            const [loadingDetails, setLoadingDetails] = useState(false);

            useEffect(() => {
                loadConversations();
            }, []);

            const loadConversations = async () => {
                try {
                    const token = await getAuthToken();
                    if (!token) {
                        console.warn('No auth token');
                        return;
                    }

                    const response = await fetch(`${BFF_API_BASE}/conversations?limit=20`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load conversations');
                    }

                    const data = await response.json();
                    console.log('Loaded conversations:', data);
                    setConversations(data.conversations || []);

                } catch (err) {
                    console.error('Failed to load conversations:', err);
                    setConversations([]);
                } finally {
                    setLoading(false);
                }
            };

            const openConversationInChat = (conversation) => {
                const conversationId = conversation.conversation_id || conversation.id;
                console.log(`Opening reflection viewer: ${conversationId}`);

                // Open in reflection viewer (stay in reflections view)
                setLoadedSessionId(conversationId);
            };

            if (loading) {
                return (
                    <div className="flex-1 flex items-center justify-center" style={{ background: '#000' }}>
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-gray-400">Loading your reflections...</p>
                        </div>
                    </div>
                );
            }

            if (conversations.length === 0) {
                return (
                    <div className="flex-1 flex items-center justify-center" style={{ background: '#000' }}>
                        <div className="text-center max-w-lg">
                            <div style={{ fontSize: '4rem', marginBottom: '1.5rem' }}>üìö</div>
                            <h2 className="text-2xl font-bold text-white mb-4">No Reflections Yet</h2>
                            <p className="text-gray-400 mb-6">
                                Your past conversations with Auron will appear here after 5 minutes of inactivity.
                            </p>
                            <p className="text-gray-500 text-sm">
                                Each conversation becomes a memory that shapes your Neural Music Profile.
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-full overflow-hidden" style={{ background: '#000' }}>
                    <div className="p-12">
                        {/* Header */}
                        <div className="text-center mb-12 relative">
                            <h1 className="text-4xl font-bold glow mb-2" style={{
                                background: 'linear-gradient(135deg, #00A8FF 0%, #005CFF 100%)',
                                WebkitBackgroundClip: 'text',
                                WebkitTextFillColor: 'transparent',
                                backgroundClip: 'text',
                                letterSpacing: '0.05em'
                            }}>
                                YOUR REFLECTIONS
                            </h1>
                            <p className="text-gray-500 text-sm">
                                {conversations.length} conversation{conversations.length !== 1 ? 's' : ''} with Auron
                            </p>

                            {/* Refresh Button */}
                            <button
                                onClick={(e) => {
                                    e.preventDefault();
                                    loadConversations();
                                }}
                                disabled={loading}
                                className="absolute right-0 top-0 px-5 py-2 rounded-full text-sm font-medium transition-all bg-white/5 text-gray-400 hover:text-white hover:bg-white/10 border border-white/10 disabled:opacity-50 disabled:cursor-not-allowed"
                                style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.5rem'
                                }}>
                                <span>üîÑ</span>
                                <span>Refresh</span>
                            </button>
                        </div>

                        {/* Horizontal Scrolling Cards */}
                        <div className="relative">
                            <div className="overflow-x-auto pb-8" style={{
                                scrollbarWidth: 'thin',
                                scrollbarColor: '#00A8FF #1a1a1a'
                            }}>
                                <div className="flex gap-6" style={{ minWidth: 'min-content' }}>
                                    {conversations.map((conv, idx) => (
                                        <div
                                            key={conv.id || idx}
                                            className="glass-card rounded-2xl p-6 flex-shrink-0"
                                            onClick={() => openConversationInChat(conv)}
                                            style={{
                                                width: '380px',
                                                background: 'rgba(10, 10, 31, 0.6)',
                                                border: '1px solid rgba(0, 168, 255, 0.2)',
                                                cursor: 'pointer'
                                            }}>
                                            {/* Date */}
                                            <div className="text-xs text-primary font-semibold uppercase tracking-wider mb-3">
                                                {new Date(conv.timestamp || conv.created_at).toLocaleDateString('en-US', {
                                                    month: 'short',
                                                    day: 'numeric',
                                                    year: 'numeric'
                                                })}
                                            </div>

                                            {/* Summary or first message */}
                                            <h3 className="text-white font-semibold text-lg mb-3 line-clamp-2">
                                                {conv.summary || conv.title || 'Conversation with Auron'}
                                            </h3>

                                            {/* Preview text */}
                                            {conv.preview && (
                                                <p className="text-gray-400 text-sm leading-relaxed mb-4 line-clamp-3">
                                                    {conv.preview}
                                                </p>
                                            )}

                                            {/* Metadata */}
                                            <div className="flex items-center gap-4 mt-4 pt-4 border-t border-gray-800">
                                                {conv.emotions && conv.emotions.length > 0 && (
                                                    <div className="flex gap-2">
                                                        {conv.emotions.slice(0, 3).map((emotion, i) => (
                                                            <span
                                                                key={i}
                                                                className="text-xs px-2 py-1 rounded-full bg-primary/10 text-primary">
                                                                {emotion}
                                                            </span>
                                                        ))}
                                                    </div>
                                                )}
                                                {conv.message_count && (
                                                    <span className="text-xs text-gray-500 ml-auto">
                                                        {conv.message_count} messages
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Scroll Hint */}
                        {conversations.length > 2 && (
                            <div className="text-center mt-8">
                                <p className="text-gray-600 text-xs">
                                    ‚Üê Scroll to explore your conversations ‚Üí
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Reflection Viewer Component (Clean Full Screen Modal)
        function ReflectionViewer({ conversationId, onClose, setSessionId }) {
            const [messages, setMessages] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [input, setInput] = useState('');
            const [chatLoading, setChatLoading] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                loadConversation();
            }, [conversationId]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const loadConversation = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    const token = await getAuthToken();

                    // Step 1: Verify access with BFF
                    const verifyResponse = await fetch(`${BFF_API_BASE}/get-conversation`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ conversation_id: conversationId })
                    });

                    if (!verifyResponse.ok) throw new Error('Failed to verify conversation access');

                    const { signed_url, encryption_key } = await verifyResponse.json();

                    // Step 2: Fetch from BunnyCDN
                    const bunnyResponse = await fetch(signed_url);
                    if (!bunnyResponse.ok) throw new Error('Failed to fetch from BunnyCDN CDN');

                    // Step 3: Decrypt
                    const encryptedData = await bunnyResponse.arrayBuffer();
                    const conversationData = await decryptConversation(encryptedData, encryption_key);

                    setMessages(conversationData.messages || []);
                } catch (err) {
                    console.error('Failed to load reflection:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleSendMessage = async () => {
                if (!input.trim() || chatLoading) return;

                const userMessage = input.trim();
                setInput('');
                setChatLoading(true);

                // Capture conversation history BEFORE adding new message
                const conversationHistory = messages.map(msg => ({
                    role: msg.role === 'auron' ? 'assistant' : msg.role,
                    content: msg.content
                }));

                // Add user message immediately for UI
                setMessages(prev => [...prev, { role: 'user', content: userMessage }]);

                try {
                    const token = await getAuthToken();

                    // Send message with full conversation history + original session_id
                    const response = await fetch(`${DIALOGUE_API_BASE}/chat`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: userMessage,
                            conversation_history: conversationHistory,
                            session_id: conversationId  // Continue existing conversation with original ID
                        })
                    });

                    if (!response.ok) throw new Error('Failed to send message');

                    const data = await response.json();

                    // Save session_id to enable sync button in header
                    if (data.metadata && data.metadata.session_id) {
                        setSessionId(data.metadata.session_id);
                        console.log(`‚úì Session active: ${data.metadata.session_id}`);
                    }

                    // Handle both structured dialogue response and simple message
                    const auronMessage = data.message?.guidance || data.response || data.message;
                    setMessages(prev => [...prev, { role: 'auron', content: auronMessage }]);

                } catch (err) {
                    console.error('Failed to send message:', err);
                    setMessages(prev => [...prev, {
                        role: 'auron',
                        content: 'Sorry, I encountered an error. Please try again.'
                    }]);
                } finally {
                    setChatLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };

            return (
                <div className="fixed inset-0 z-50" style={{ background: 'rgba(0, 0, 0, 0.95)' }}>
                    {/* Close Button */}
                    <button
                        onClick={onClose}
                        className="absolute top-8 right-8 w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/10 transition-all text-gray-400 hover:text-white text-2xl">
                        ‚úï
                    </button>

                    {/* Main Container */}
                    <div className="w-full max-w-4xl mx-auto px-8 h-full flex flex-col py-8">

                        {/* Header */}
                        <div className="py-6 border-b border-white/10 mb-6">
                            <h2 className="text-2xl font-semibold text-center text-primary glow">
                                Reflection
                            </h2>
                        </div>

                        {/* Messages Container */}
                        <div className="flex-1 overflow-y-auto mb-6" style={{
                            scrollbarWidth: 'thin',
                            scrollbarColor: '#00A8FF #1a1a1a'
                        }}>
                            {loading && (
                                <div className="text-center text-gray-400 py-12">
                                    Loading...
                                </div>
                            )}

                            {error && (
                                <div className="text-center text-red-400 py-12">
                                    Error: {error}
                                </div>
                            )}

                            {!loading && !error && (
                                <div className="space-y-6">
                                    {messages.map((msg, idx) => (
                                        <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`rounded-2xl px-6 py-4 ${
                                                msg.role === 'user'
                                                    ? 'max-w-[70%] bg-gradient-to-r from-primary/30 to-primary-dark/30 border border-primary/50'
                                                    : 'max-w-[75%] bg-gray-900 border border-gray-800'
                                            }`}>
                                                <p className="text-xs font-semibold text-primary uppercase tracking-wide mb-2 glow">
                                                    {msg.role === 'user' ? 'You' : 'Auron'}
                                                </p>
                                                <p className="text-white leading-relaxed" style={{ lineHeight: '1.7' }}>
                                                    {msg.content}
                                                </p>
                                            </div>
                                        </div>
                                    ))}

                                    {chatLoading && (
                                        <div className="flex justify-start">
                                            <div className="max-w-[75%] rounded-2xl px-6 py-4 bg-gray-900 border border-gray-800">
                                                <p className="text-xs font-semibold text-primary uppercase tracking-wide mb-2 glow">
                                                    Auron
                                                </p>
                                                <div className="flex gap-1">
                                                    <div className="w-2 h-2 rounded-full bg-primary animate-bounce"></div>
                                                    <div className="w-2 h-2 rounded-full bg-primary animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                                                    <div className="w-2 h-2 rounded-full bg-primary animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div ref={messagesEndRef} />
                                </div>
                            )}
                        </div>

                        {/* Chat Input */}
                        <div className="border-t border-white/5 pt-6">
                            <div className="flex gap-4">
                                <input
                                    type="text"
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    placeholder="Continue the conversation..."
                                    disabled={chatLoading}
                                    className="flex-1 px-5 py-4 bg-black/40 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
                                />
                                <button
                                    onClick={handleSendMessage}
                                    disabled={!input.trim() || chatLoading}
                                    className="btn-sci-fi px-8 py-4 rounded-xl font-semibold text-white disabled:opacity-40 disabled:cursor-not-allowed">
                                    {chatLoading ? 'Sending...' : 'Send'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function Dashboard() {
            const [user, setUser] = useState(null);
            const [currentView, setCurrentView] = useState('chat');
            const [conversationCount, setConversationCount] = useState(0);
            const [profileUnlocked, setProfileUnlocked] = useState(false);
            const [loadedSessionId, setLoadedSessionId] = useState(null);

            // Session management for sync button
            const [sessionId, setSessionId] = useState(null);
            const [syncing, setSyncing] = useState(false);

            useEffect(() => {
                // Check Logto authentication
                async function checkAuth() {
                    try {
                        const isAuth = await window.LogtoAuth.isAuthenticated();

                        if (!isAuth) {
                            console.log('Not authenticated - redirecting to login...');
                            window.location.href = 'login.html';
                            return;
                        }

                        // Get user info from Logto
                        const userInfo = await window.LogtoAuth.getUserInfo();
                        if (userInfo) {
                            console.log('‚úì User authenticated:', userInfo.username);
                            setUser(userInfo);

                            // Store for backwards compatibility
                            localStorage.setItem('auron_user', JSON.stringify(userInfo));
                        } else {
                            throw new Error('Failed to get user info');
                        }

                    } catch (err) {
                        console.error('Auth check failed:', err);
                        window.location.href = 'login.html';
                    }
                }

                checkAuth();
            }, []);

            useEffect(() => {
                // Update progress when user is loaded
                if (user) {
                    updateProgress();
                    checkForUnsyncedSessions();
                }
            }, [user]);

            // Check for unsynced sessions on page load (Option B from spec)
            const checkForUnsyncedSessions = async () => {
                try {
                    const token = await getAuthToken();
                    if (!token) return;

                    const response = await fetch(`${DIALOGUE_API_BASE}/active-sessions`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const { has_unsynced, sessions } = await response.json();

                        if (has_unsynced && sessions && sessions.length > 0) {
                            // Enable sync button with the first unsynced session
                            setSessionId(sessions[0].session_id);
                            console.log(`‚úì Found unsynced session: ${sessions[0].session_id}`);
                        }
                    }
                } catch (err) {
                    console.error('Failed to check for unsynced sessions:', err);
                }
            };

            const updateProgress = async () => {
                if (!user) return;

                // Admin override: always unlock for user 'trasted'
                const isAdmin = user.username === 'trasted' || user.id.includes('trasted');

                if (isAdmin) {
                    setProfileUnlocked(true);
                    setConversationCount(0);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/profile/${user.id}`);
                    if (response.ok) {
                        const profile = await response.json();
                        const count = profile.conversation_count || 0;
                        setConversationCount(count);
                        setProfileUnlocked(count >= UNLOCK_THRESHOLD);
                    }
                } catch (err) {
                    console.error('Failed to update progress:', err);
                }
            };

            const handleLogout = async () => {
                try {
                    console.log('Signing out...');
                    await window.LogtoAuth.signOut();
                    // Logto will redirect to index.html (configured as post-signout URI)
                } catch (err) {
                    console.error('Sign out failed:', err);
                    // Fallback: clear storage and redirect manually
                    localStorage.removeItem('auron_user');
                    localStorage.removeItem('auron_auth_token');
                    window.location.href = 'index.html';
                }
            };

            // Save session to backend (triggers pattern extraction)
            const saveSession = useCallback(async () => {
                if (!sessionId) return;
                if (syncing) return;  // Prevent duplicate saves

                try {
                    setSyncing(true);
                    const token = await getAuthToken();
                    if (!token) {
                        console.warn('No auth token - cannot save session');
                        setSyncing(false);
                        return;
                    }

                    console.log(`Saving session: ${sessionId}`);
                    const response = await fetch(`${DIALOGUE_API_BASE}/save-session`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ session_id: sessionId })
                    });

                    if (response.ok) {
                        console.log('‚úì Session saved successfully');
                        updateProgress();  // Refresh conversation count
                    } else {
                        console.error('Failed to save session:', response.status);
                    }

                    // Clear session after save
                    setSessionId(null);

                } catch (err) {
                    console.error('Failed to save session:', err);
                } finally {
                    setSyncing(false);
                }
            }, [sessionId, syncing]);

            // Manual sync handler
            const handleManualSync = useCallback(async () => {
                if (!sessionId || syncing) return;
                console.log('Manual sync triggered');
                await saveSession();
            }, [sessionId, syncing, saveSession]);

            if (!user) return <div className="flex items-center justify-center h-screen text-white">Loading...</div>;

            return (
                <div className="h-screen flex flex-col overflow-hidden">
                    {/* Professional Header Navigation (Neural Music style - dark theme) */}
                    <header className="fixed top-0 w-full glass border-b border-white/5 z-50">
                        <div className="max-w-7xl mx-auto px-8 py-5 flex items-center justify-between">
                            {/* Logo */}
                            <div className="flex items-center gap-4">
                                <h1 className="text-2xl font-bold tracking-tight" style={{
                                    color: '#00D9FF',
                                    textShadow: '0 0 20px rgba(0, 217, 255, 0.8), 0 0 40px rgba(0, 191, 255, 0.6), 0 0 60px rgba(0, 153, 255, 0.4)'
                                }}>
                                    AURON
                                </h1>
                            </div>

                            {/* Navigation + Progress */}
                            <nav className="flex items-center gap-8">
                                <button
                                    className={`px-5 py-2 rounded-full text-sm font-medium transition-all ${
                                        currentView === 'chat'
                                            ? 'bg-white/5 text-white'
                                            : 'text-gray-400 hover:text-white'
                                    }`}
                                    onClick={() => setCurrentView('chat')}>
                                    üí¨ Dialogue
                                </button>

                                <button
                                    className={`px-5 py-2 rounded-full text-sm font-medium transition-all ${
                                        currentView === 'reflections'
                                            ? 'bg-white/5 text-white'
                                            : 'text-gray-400 hover:text-white'
                                    }`}
                                    onClick={() => setCurrentView('reflections')}>
                                    üìö Reflections
                                </button>

                                <button
                                    className={`px-5 py-2 rounded-full text-sm font-medium transition-all ${
                                        !profileUnlocked && 'opacity-50 cursor-not-allowed'
                                    } ${
                                        currentView === 'profile'
                                            ? 'bg-white/5 text-white'
                                            : 'text-gray-400 hover:text-white'
                                    }`}
                                    onClick={() => profileUnlocked && setCurrentView('profile')}>
                                    üß† Profile {profileUnlocked ? 'üîì' : 'üîí'}
                                </button>

                                {/* Progress Indicator */}
                                <div className="flex items-center gap-3 px-5 py-2 rounded-full bg-white/5 border border-white/5">
                                    <span className="text-xs font-semibold text-gray-400 uppercase tracking-wider">
                                        {conversationCount} / {UNLOCK_THRESHOLD}
                                    </span>
                                    <div className="w-16 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                        <div
                                            className="h-full rounded-full transition-all duration-500"
                                            style={{
                                                width: `${Math.min((conversationCount / UNLOCK_THRESHOLD) * 100, 100)}%`,
                                                background: 'linear-gradient(90deg, #00D9FF 0%, #00BFFF 100%)'
                                            }}
                                        />
                                    </div>
                                </div>

                                {/* Sync Button */}
                                <button
                                    onClick={handleManualSync}
                                    disabled={!sessionId || syncing}
                                    className="px-4 py-2 rounded-full text-sm font-medium transition-all disabled:opacity-30 disabled:cursor-not-allowed"
                                    style={{
                                        background: sessionId && !syncing ? 'rgba(0, 217, 255, 0.1)' : 'rgba(100, 100, 100, 0.1)',
                                        color: sessionId && !syncing ? '#00D9FF' : '#666',
                                        border: `1px solid ${sessionId && !syncing ? 'rgba(0, 217, 255, 0.3)' : 'rgba(100, 100, 100, 0.2)'}`
                                    }}
                                    title={!sessionId ? 'No conversation to sync' : syncing ? 'Syncing...' : 'Save conversation to Reflections'}>
                                    {syncing ? '‚Üª Syncing...' : '‚Üª Sync'}
                                </button>

                                {/* User Avatar with Dropdown */}
                                <UserAvatarDropdown username={user.username || 'user'} />

                                <button
                                    onClick={handleLogout}
                                    className="text-sm text-gray-400 hover:text-white transition-colors">
                                    Sign Out
                                </button>
                            </nav>
                        </div>
                    </header>

                    {/* Main Content - Generous whitespace, centered */}
                    <main className="flex-1 pt-24 overflow-hidden">
                        {currentView === 'chat' ? (
                            <ChatView
                                user={user}
                                onUpdateProgress={updateProgress}
                                loadedSessionId={loadedSessionId}
                                sessionId={sessionId}
                                setSessionId={setSessionId}
                                setSyncing={setSyncing}
                            />
                        ) : currentView === 'reflections' ? (
                            <ReflectionsView user={user} setCurrentView={setCurrentView} setLoadedSessionId={setLoadedSessionId} />
                        ) : (
                            <ProfileView user={user} isLocked={!profileUnlocked} conversationCount={conversationCount} />
                        )}
                    </main>

                    {/* Reflection Viewer Modal (Full Screen) */}
                    {loadedSessionId && (
                        <ReflectionViewer
                            conversationId={loadedSessionId}
                            onClose={() => setLoadedSessionId(null)}
                            setSessionId={setSessionId}
                        />
                    )}
                </div>
            );
        }

        function ChatView({ user, onUpdateProgress, loadedSessionId, sessionId, setSessionId, setSyncing }) {
            const [messages, setMessages] = useState([
                { role: 'auron', content: "Hello. I'm Auron, your creative psychologist. Share what's on your mind ‚Äî whether it's frustration, curiosity, or something you can't quite name yet. I'm listening." }
            ]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [currentDialogue, setCurrentDialogue] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [sidebarSources, setSidebarSources] = useState([]);
            const [blueprintPanelOpen, setBlueprintPanelOpen] = useState(false);
            const [blueprintPanelSources, setBlueprintPanelSources] = useState([]);
            const messagesEndRef = useRef(null);

            // SSE Streaming state
            const [sseProgress, setSSEProgress] = useState(0);
            const [sseCurrentStage, setSSECurrentStage] = useState('');
            const [sseCompletedStages, setSSECompletedStages] = useState([]);
            const [isPanelFading, setIsPanelFading] = useState(false);

            // Token streaming state (use ref to avoid closure issues)
            const streamingMessageIndexRef = useRef(null);
            const streamingGuidanceRef = useRef('');
            const blueprintSourcesRef = useRef(null);
            const [isStreaming, setIsStreaming] = useState(false);
            const sseCleanupRef = useRef(null);

            // Session management (backend holds conversation in RAM)
            const [needsLoadSession, setNeedsLoadSession] = useState(false);

            // Load past conversation from Reflections
            useEffect(() => {
                if (loadedSessionId) {
                    console.log('Loading past conversation:', loadedSessionId);

                    const loadPastMessages = async () => {
                        try {
                            setLoading(true);
                            const token = await getAuthToken();

                            // Step 1: Verify access with BFF
                            const verifyResponse = await fetch(`${BFF_API_BASE}/get-conversation`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    conversation_id: loadedSessionId
                                })
                            });

                            if (!verifyResponse.ok) throw new Error('Failed to verify conversation access');

                            const { signed_url, encryption_key } = await verifyResponse.json();
                            console.log('Access verified, fetching from CDN with signed URL');

                            // Step 2: Fetch from BunnyCDN Pull Zone (token-authenticated)
                            const bunnyResponse = await fetch(signed_url);

                            if (!bunnyResponse.ok) throw new Error('Failed to fetch from BunnyCDN CDN');

                            // Check if encrypted (binary) or plain JSON
                            const contentType = bunnyResponse.headers.get('content-type');
                            console.log('Content-Type:', contentType);

                            let conversationData;
                            if (contentType && contentType.includes('application/json')) {
                                // Plain JSON
                                conversationData = await bunnyResponse.json();
                            } else {
                                // Encrypted binary - decrypt it
                                const encryptedData = await bunnyResponse.arrayBuffer();
                                console.log('Encrypted data size:', encryptedData.byteLength);

                                // Decrypt the conversation with user-specific key from BFF
                                conversationData = await decryptConversation(encryptedData, encryption_key);
                            }

                            console.log('Conversation loaded from CDN:', conversationData);

                            // Replace default message with past conversation
                            setMessages(conversationData.messages || []);
                            setSessionId(loadedSessionId);
                            setNeedsLoadSession(true);  // Flag: needs to be loaded into RAM when user sends message

                        } catch (err) {
                            console.error('Failed to load past conversation:', err);
                        } finally {
                            setLoading(false);
                        }
                    };

                    loadPastMessages();
                }
            }, [loadedSessionId]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            // Cleanup SSE connection on unmount
            useEffect(() => {
                return () => {
                    if (sseCleanupRef.current) {
                        console.log('Cleaning up SSE connection');
                        sseCleanupRef.current();
                    }
                };
            }, []);

            const handleSendMessage = async (messageText) => {
                setMessages(prev => [...prev, { role: 'user', content: messageText }]);
                setLoading(true);
                setIsStreaming(true);

                // Reset SSE state
                setSSEProgress(0);
                setSSECurrentStage('');
                setSSECompletedStages([]);
                setIsPanelFading(false);
                streamingMessageIndexRef.current = null;
                streamingGuidanceRef.current = '';

                try {
                    // Get access token for authentication
                    const token = await getAuthToken();
                    if (!token) {
                        throw new Error('Not authenticated - please log in again');
                    }

                    // If this is a loaded conversation (not yet in RAM), load it first
                    if (needsLoadSession && sessionId) {
                        console.log('Auto-loading session into RAM:', sessionId);

                        const loadResponse = await fetch(`${DIALOGUE_API_BASE}/load-session`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                conversation_id: sessionId
                            })
                        });

                        if (loadResponse.ok) {
                            console.log('‚úì Session loaded into backend RAM');
                            setNeedsLoadSession(false);  // Only load once
                        }
                    }

                    // Connect to SSE streaming
                    const cleanup = await connectSSEChat({
                        message: messageText,
                        sessionId: sessionId,
                        token: token,
                        onProgress: (event) => {
                            // Update progress UI
                            setSSEProgress(event.progress);
                            setSSECurrentStage(event.type);

                            // Add completed stage (on *_complete events OR blueprint events)
                            if (event.type.endsWith('_complete') ||
                                event.type === 'blueprint_retrieved' ||
                                event.type === 'blueprint_skipped') {
                                setSSECompletedStages(prev => [...prev, event.type]);
                            }
                        },
                        onBlueprintRetrieved: (data) => {
                            console.log('üìò Blueprint sources retrieved:', data);
                            // Store blueprint sources for later use in dialogue
                            blueprintSourcesRef.current = data.sources || [];
                        },
                        onBlueprintSkipped: (data) => {
                            console.log('üìò Blueprint skipped:', data.reason);
                            blueprintSourcesRef.current = null;
                        },
                        onAuronGenerating: () => {
                            // console.log('üéØ Auron is generating response - creating streaming message immediately');

                            // Create placeholder message immediately (don't wait for fade)
                            setMessages(prev => {
                                streamingMessageIndexRef.current = prev.length;
                                // console.log(`üìù Created streaming message at index ${streamingMessageIndexRef.current}`);

                                return [...prev, {
                                    role: 'auron',
                                    content: '',
                                    isStreaming: true,
                                    guidance: ''
                                }];
                            });

                            // DON'T reset buffer - keep accumulated tokens
                            // streamingGuidanceRef.current is already empty or will be used

                            // Start fade-out animation (visual only, doesn't affect token capture)
                            setIsPanelFading(true);
                            setTimeout(() => {
                                setIsStreaming(false); // Hide ThinkingPanel after fade
                            }, 1200);
                        },
                        onAuronToken: (token) => {
                            // Append token to streaming guidance using ref
                            streamingGuidanceRef.current += token;
                            let rawText = streamingGuidanceRef.current;
                            const currentIndex = streamingMessageIndexRef.current;

                            // Strip markers from display (backend sends plain text with markers)
                            let displayText = rawText;

                            // Remove "GUIDANCE:\n" or "GUIDANCE:" prefix
                            displayText = displayText.replace(/^GUIDANCE:\s*/i, '');

                            // Remove "REFLECTIVE QUESTION:" section (only show guidance during streaming)
                            const reflectiveIndex = displayText.search(/\n\s*REFLECTIVE QUESTION:/i);
                            if (reflectiveIndex !== -1) {
                                displayText = displayText.substring(0, reflectiveIndex).trim();
                            }

                            // console.log(`üìù Token: "${token}" | Index: ${currentIndex} | Raw: ${rawText.length} chars | Display: ${displayText.length} chars`);

                            // Update the streaming message with clean text
                            if (currentIndex !== null) {
                                setMessages(msgs => msgs.map((msg, idx) =>
                                    idx === currentIndex
                                        ? { ...msg, guidance: displayText, content: displayText }
                                        : msg
                                ));
                            }
                        },
                        onAuronComplete: (data) => {
                            // console.log('‚úÖ Auron response complete - converting to structured dialogue:', data);

                            const { guidance, reflective_question } = data;
                            const currentIndex = streamingMessageIndexRef.current;
                            let streamedText = streamingGuidanceRef.current;

                            // Strip markers from streamed text for comparison
                            let cleanStreamedText = streamedText.replace(/^GUIDANCE:\s*/i, '');
                            const reflectiveIndex = cleanStreamedText.search(/\n\s*REFLECTIVE QUESTION:/i);
                            if (reflectiveIndex !== -1) {
                                cleanStreamedText = cleanStreamedText.substring(0, reflectiveIndex).trim();
                            }

                            // Use guidance from auron_complete (it's parsed and guaranteed clean)
                            // Backend parses "GUIDANCE:" and "REFLECTIVE QUESTION:" markers for us
                            const finalGuidance = guidance || cleanStreamedText || '';
                            const finalQuestion = reflective_question || null;

                            // console.log(`üìä Final content (using COMPLETE guidance from backend):`);
                            // console.log(`   Streamed (raw): "${streamedText.substring(0, 60)}..." (${streamedText.length} chars)`);
                            // console.log(`   Streamed (clean): "${cleanStreamedText.substring(0, 60)}..." (${cleanStreamedText.length} chars)`);
                            // console.log(`   Complete (parsed): "${guidance?.substring(0, 60)}..." (${guidance?.length || 0} chars)`);
                            // console.log(`   Using: ${finalGuidance === guidance ? 'PARSED COMPLETE' : 'STREAMED'} text`);
                            // console.log(`   Question: ${finalQuestion || 'none'}`);

                            // Transform streaming message to full structured dialogue
                            if (currentIndex !== null) {
                                setMessages(msgs => msgs.map((msg, idx) =>
                                    idx === currentIndex
                                        ? {
                                            role: 'auron',
                                            content: "View Insight ‚Üí",
                                            isDialogue: true,
                                            isStreaming: false,
                                            dialogue: {
                                                guidance: finalGuidance,
                                                reflective_question: finalQuestion,
                                                sources: null,
                                                research_quality: null,
                                                cited_references: null,
                                                research_synthesis: null,
                                                blueprint_sources: blueprintSourcesRef.current
                                            }
                                        }
                                        : msg
                                ));
                            }

                            // Clear streaming state
                            streamingMessageIndexRef.current = null;
                            streamingGuidanceRef.current = '';
                            blueprintSourcesRef.current = null;
                        },
                        onComplete: (result) => {
                            console.log('SSE Complete - final metadata:', result);

                            // Save session_id from response
                            if (result.metadata && result.metadata.session_id) {
                                setSessionId(result.metadata.session_id);
                                console.log(`Session ID: ${result.metadata.session_id}`);
                            }

                            // Update the message with sources and research data if available
                            const currentIndex = streamingMessageIndexRef.current;
                            if (currentIndex !== null && result.sources) {
                                setMessages(msgs => msgs.map((msg, idx) =>
                                    idx === currentIndex && msg.dialogue
                                        ? {
                                            ...msg,
                                            dialogue: {
                                                ...msg.dialogue,
                                                sources: result.sources || msg.dialogue.sources,
                                                research_quality: result.analysis?.web_search?.research_quality || msg.dialogue.research_quality,
                                                cited_references: result.analysis?.cited_references || msg.dialogue.cited_references,
                                                research_synthesis: result.research_synthesis || msg.dialogue.research_synthesis
                                            }
                                        }
                                        : msg
                                ));
                            }

                            // Update progress
                            setTimeout(onUpdateProgress, 1000);

                            // Clear streaming state
                            setIsStreaming(false);
                            setLoading(false);
                            setIsPanelFading(false);
                        },
                        onError: (error) => {
                            console.error('SSE Error - falling back to regular chat:', error);

                            // Fallback to regular /chat endpoint
                            fetch(`${DIALOGUE_API_BASE}/chat`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    message: messageText,
                                    metadata: { session_id: sessionId }
                                })
                            })
                            .then(res => res.json())
                            .then(data => {
                                // Save session_id
                                if (data.metadata && data.metadata.session_id) {
                                    setSessionId(data.metadata.session_id);
                                }

                                // Parse and display response
                                const messageData = data.auron_response || data.message;
                                const parsedMessage = typeof messageData === 'string'
                                    ? { guidance: messageData, reflective_question: "What insight from this resonates most with you?" }
                                    : messageData;

                                const dialogueWithSources = {
                                    ...parsedMessage,
                                    sources: data.sources || null,
                                    research_quality: data.analysis?.web_search?.research_quality || null,
                                    cited_references: data.analysis?.cited_references || null,
                                    research_synthesis: data.research_synthesis || null
                                };

                                setMessages(prev => [...prev, {
                                    role: 'auron',
                                    content: "View Insight ‚Üí",
                                    isDialogue: true,
                                    dialogue: dialogueWithSources
                                }]);

                                setTimeout(onUpdateProgress, 1000);
                            })
                            .catch(err => {
                                setMessages(prev => [...prev, { role: 'auron', content: `Error: ${err.message}` }]);
                            })
                            .finally(() => {
                                setIsStreaming(false);
                                setLoading(false);
                            });
                        }
                    });

                    // Store cleanup function
                    sseCleanupRef.current = cleanup;

                } catch (err) {
                    setMessages(prev => [...prev, { role: 'auron', content: `Error: ${err.message}` }]);
                    setIsStreaming(false);
                    setLoading(false);
                }
            };

            const handleSend = () => {
                if (!input.trim() || loading) return;
                const userMessage = input.trim();
                setInput('');
                handleSendMessage(userMessage);
            };

            return (
                <div className="h-full flex flex-col overflow-hidden">
                    {/* ThinkingPanel - SSE Progress Display */}
                    {(isStreaming || isPanelFading) && (
                        <ThinkingPanel
                            stage={sseCurrentStage}
                            progress={sseProgress}
                            completedStages={sseCompletedStages}
                            isFading={isPanelFading}
                        />
                    )}

                    {/* Dialogue Modal */}
                    {currentDialogue && (
                        <DialogueModal
                            dialogue={currentDialogue}
                            onClose={() => setCurrentDialogue(null)}
                            onSendResponse={(response) => {
                                setCurrentDialogue(null);
                                handleSendMessage(response);
                            }}
                        />
                    )}

                    {/* References Sidebar - Slides in from right */}
                    <ReferencesSidebar
                        isOpen={sidebarOpen}
                        onClose={() => setSidebarOpen(false)}
                        sources={sidebarSources}
                    />

                    {/* Blueprint Floating Panel - Appears on right when clicked */}
                    <BlueprintFloatingPanel
                        isOpen={blueprintPanelOpen}
                        onClose={() => setBlueprintPanelOpen(false)}
                        sources={blueprintPanelSources}
                    />

                    {/* Messages - Generous whitespace, centered (Neural Music style) */}
                    <div className="flex-1 overflow-y-auto py-16 px-8" style={{
                        scrollbarWidth: 'thin',
                        scrollbarColor: '#00A8FF #1a1a1a'
                    }}>
                        <div className="max-w-4xl mx-auto space-y-8">
                            {messages.map((msg, idx) => (
                                <DialogueMessage
                                    key={idx}
                                    message={msg}
                                    onOpenDialogue={(dialogue) => setCurrentDialogue(dialogue)}
                                    onOpenReferences={(sources) => {
                                        setSidebarSources(sources);
                                        setSidebarOpen(true);
                                    }}
                                    onOpenBlueprintPanel={(sources) => {
                                        setBlueprintPanelSources(sources);
                                        setBlueprintPanelOpen(true);
                                    }}
                                    onCloseBlueprintPanel={() => setBlueprintPanelOpen(false)}
                                    sendMessage={handleSendMessage}
                                />
                            ))}

                            <div ref={messagesEndRef} />
                        </div>
                    </div>

                    {/* Input - Clean, professional */}
                    <div className="py-8 px-8 border-t border-white/5">
                        <div className="max-w-4xl mx-auto flex gap-4">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                                placeholder="Share what's on your mind..."
                                className="flex-1 px-5 py-4 bg-black/40 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
                            />
                            <button
                                onClick={handleSend}
                                disabled={loading || !input.trim()}
                                className="px-8 py-4 rounded-xl font-semibold text-white disabled:opacity-40 disabled:cursor-not-allowed transition-all"
                                style={{
                                    background: loading ? '#666' : 'linear-gradient(135deg, #000DFF 0%, #001AFF 100%)'
                                }}>
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function ProfileView({ user, isLocked, conversationCount }) {
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadProfile();
            }, []);

            const loadProfile = async () => {
                try {
                    // Get authentication token
                    const token = await getAuthToken();
                    if (!token) {
                        console.error('No authentication token available');
                        throw new Error('Authentication required');
                    }

                    // Call BFF API with JWT authentication
                    const response = await fetch(`${BFF_API_BASE}/profile`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        console.error('Profile fetch failed with status:', response.status);
                        const errorData = await response.json().catch(() => ({}));
                        console.error('Error details:', errorData);
                        throw new Error('Profile not found');
                    }

                    const data = await response.json();
                    console.log('Profile loaded successfully from BFF:', data);
                    setProfile(data);
                } catch (err) {
                    console.error('Failed to load profile:', err);
                    // Set empty profile on error
                    setProfile({
                        dimensions: {
                            sound_description: null,
                            sonic_title: "EMERGING IDENTITY",
                            genre_fusion: [],
                            neural_spectrum: [],
                            sound_palette: [],
                            tonal_dna: [],
                            rhythmic_dna: [],
                            emotional_fingerprint: [],
                            processing_signature: [],
                            inspirational_triggers: [],
                            sonic_architecture: []
                        },
                        conversation_count: 0
                    });
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return (
                    <div className="flex-1 flex items-center justify-center" style={{ background: '#000' }}>
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-gray-400">Loading your Neural Music Profile...</p>
                        </div>
                    </div>
                );
            }

            const dims = profile?.dimensions || {};

            // Handle nested sound_description object
            const soundDescObj = dims.sound_description || {};
            const sonicTitle = soundDescObj.sonic_title || 'EMERGING IDENTITY';
            const soundDescription = soundDescObj.description || soundDescObj.sonic_description || null;

            // Handle neural_spectrum object (has position and direction)
            const neuralSpectrum = dims.neural_spectrum || {};

            // Extract nested arrays and objects from the actual data structure
            const genreFusion = dims.genre_fusion || [];
            const soundPalette = dims.sound_palette || [];

            // tonal_dna is an object with numeric properties, not an array
            const tonalDNA = dims.tonal_dna || {};
            const rhythmicDNA = dims.rhythmic_dna || {};

            // emotional_fingerprint.nodes is the array
            const emotionalFingerprint = (dims.emotional_fingerprint?.nodes) || [];

            const processingSignature = dims.processing_signature || [];

            // inspirational_triggers.sources is the array
            const inspirationalTriggers = (dims.inspirational_triggers?.sources) || [];

            // sonic_architecture is an object with layering_approach and tension_release
            const sonicArchitecture = dims.sonic_architecture || {};

            return (
                <div className="h-full overflow-y-auto relative" style={{ background: '#000' }}>
                    {/* Content */}
                    <div className={`p-12 ${isLocked ? 'filter blur-md' : ''}`}>
                        <div className="max-w-7xl mx-auto space-y-12">
                            {/* Header */}
                            <div className="text-center mb-12">
                                <h1 className="text-4xl font-bold glow mb-2" style={{
                                    background: 'linear-gradient(135deg, #00A8FF 0%, #005CFF 100%)',
                                    WebkitBackgroundClip: 'text',
                                    WebkitTextFillColor: 'transparent',
                                    backgroundClip: 'text',
                                    letterSpacing: '0.05em'
                                }}>
                                    NEURAL MUSIC PROFILE
                                </h1>
                                <p className="text-gray-500 text-sm">Mapping the inner architecture of sound and mind</p>
                            </div>

                            {/* Top Row: Sonic Title + Genre Fusion */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                {/* Sonic Title Card */}
                                <div className="card-glow rounded-xl p-8" style={{ background: 'rgba(10, 10, 20, 0.6)' }}>
                                    <p className="text-xs text-primary font-semibold uppercase tracking-wider mb-4">Sonic Title</p>
                                    <h2 className="text-3xl font-black glow mb-4" style={{
                                        background: 'linear-gradient(135deg, #00A8FF 0%, #005CFF 100%)',
                                        WebkitBackgroundClip: 'text',
                                        WebkitTextFillColor: 'transparent',
                                        backgroundClip: 'text'
                                    }}>
                                        {sonicTitle}
                                    </h2>
                                    {soundDescription && (
                                        <p className="text-gray-400 text-sm leading-relaxed">{soundDescription}</p>
                                    )}
                                    {!soundDescription && (
                                        <p className="text-gray-600 text-sm italic">Your sonic identity is emerging...</p>
                                    )}
                                </div>

                                {/* Genre Fusion Ring */}
                                <div className="card-glow rounded-xl p-8" style={{ background: 'rgba(10, 10, 20, 0.6)' }}>
                                    <p className="text-xs text-primary font-semibold uppercase tracking-wider mb-4">Sonic Code / Genre Fusion</p>
                                    <GenreFusionRing data={genreFusion} />
                                </div>
                            </div>

                            {/* Neural Spectrum - Full Width */}
                            <div className="card-glow rounded-xl p-8" style={{ background: 'rgba(10, 10, 20, 0.6)' }}>
                                <p className="text-xs text-primary font-semibold uppercase tracking-wider mb-4">Neural Spectrum</p>
                                <NeuralSpectrumBar data={neuralSpectrum} />
                            </div>

                            {/* Middle Row: Sound System + Tonal DNA + Rhythmic DNA */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                <div className="card-glow rounded-xl p-6" style={{ background: 'rgba(10, 10, 20, 0.6)' }}>
                                    <p className="text-xs text-primary font-semibold uppercase tracking-wider mb-4">Sound System</p>
                                    <SoundPaletteOrbital data={soundPalette} />
                                </div>

                                <div className="card-glow rounded-xl p-6" style={{ background: 'rgba(10, 10, 20, 0.6)' }}>
                                    <p className="text-xs text-primary font-semibold uppercase tracking-wider mb-4">Tonal DNA</p>
                                    <TonalDNAQuadrant data={tonalDNA} />
                                </div>

                                <div className="card-glow rounded-xl p-6" style={{ background: 'rgba(10, 10, 20, 0.6)' }}>
                                    <p className="text-xs text-primary font-semibold uppercase tracking-wider mb-4">Rhythmic DNA</p>
                                    <RhythmicDNAWaveform data={rhythmicDNA} />
                                </div>
                            </div>

                            {/* Emotional & Psychological Section */}
                            <div className="card-glow rounded-xl p-8" style={{ background: 'rgba(10, 10, 20, 0.6)' }}>
                                <p className="text-xs text-primary font-semibold uppercase tracking-wider mb-6">Emotional & Psychological</p>
                                <EmotionalBubbleNetwork data={emotionalFingerprint} />
                            </div>

                            {/* Bottom Row: Processing Signature + Inspirational Triggers */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="card-glow rounded-xl p-6" style={{ background: 'rgba(10, 10, 20, 0.6)' }}>
                                    <p className="text-xs text-primary font-semibold uppercase tracking-wider mb-4">Processing Signature</p>
                                    <DataList data={processingSignature} />
                                </div>

                                <div className="card-glow rounded-xl p-6" style={{ background: 'rgba(10, 10, 20, 0.6)' }}>
                                    <p className="text-xs text-primary font-semibold uppercase tracking-wider mb-4">Inspirational Triggers</p>
                                    <InspirationalConstellation data={inspirationalTriggers} />
                                </div>
                            </div>

                            {/* Sonic Architecture Tower */}
                            <div className="card-glow rounded-xl p-8" style={{ background: 'rgba(10, 10, 20, 0.6)' }}>
                                <p className="text-xs text-primary font-semibold uppercase tracking-wider mb-6 text-center">Sonic Architecture</p>
                                <SonicArchitectureTower data={sonicArchitecture} />
                            </div>

                            {/* Conversation Count Footer */}
                            <div className="text-center">
                                <p className="text-gray-600 text-sm">
                                    Built from <span className="text-primary font-semibold">{profile?.conversation_count || 0}</span> conversations with Auron
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* Lock Overlay */}
                    {isLocked && (
                        <div className="absolute inset-0 flex items-center justify-center" style={{ background: 'rgba(0, 0, 0, 0.85)', backdropFilter: 'blur(8px)' }}>
                            <div className="text-center max-w-lg p-12 card-glow rounded-2xl" style={{ background: 'rgba(10, 10, 15, 0.95)' }}>
                                <div className="text-7xl mb-6">üîí</div>
                                <h2 className="text-4xl font-black mb-4 glow" style={{
                                    background: 'linear-gradient(135deg, #00A8FF 0%, #005CFF 100%)',
                                    WebkitBackgroundClip: 'text',
                                    WebkitTextFillColor: 'transparent',
                                    backgroundClip: 'text'
                                }}>
                                    PROFILE LOCKED
                                </h2>
                                <p className="text-gray-300 text-lg mb-2">
                                    Have <span className="text-primary font-bold">{UNLOCK_THRESHOLD - conversationCount} more conversations</span> with Auron to unlock
                                </p>
                                <p className="text-gray-500 text-sm mb-6">
                                    Every conversation builds your 10-dimensional sonic identity
                                </p>
                                <div className="w-full bg-gray-800 rounded-full h-4 overflow-hidden mb-3">
                                    <div
                                        className="h-full rounded-full transition-all duration-500"
                                        style={{
                                            width: `${(conversationCount / UNLOCK_THRESHOLD) * 100}%`,
                                            background: 'linear-gradient(90deg, #00D9FF 0%, #00BFFF 100%)'
                                        }}
                                    />
                                </div>
                                <p className="text-gray-400 text-sm">
                                    {conversationCount} / {UNLOCK_THRESHOLD} conversations
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // 1. Genre Fusion Ring - Circular ring divided into 8 segments
        function GenreFusionRing({ data }) {
            const vizRef = useRef(null);

            useEffect(() => {
                if (!vizRef.current) return;
                d3.select(vizRef.current).selectAll('*').remove();

                if (!data || !Array.isArray(data) || data.length === 0) return;

                const width = 320;
                const height = 320;
                const radius = Math.min(width, height) / 2 - 20;

                const svg = d3.select(vizRef.current)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .append('g')
                    .attr('transform', `translate(${width/2}, ${height/2})`);

                const pie = d3.pie().value(d => d.weight || 1).padAngle(0.02);
                const arc = d3.arc()
                    .innerRadius(radius * 0.5)
                    .outerRadius(radius * 0.9);

                const arcs = svg.selectAll('arc')
                    .data(pie(data.slice(0, 8)))
                    .enter()
                    .append('g');

                arcs.append('path')
                    .attr('d', arc)
                    .attr('fill', (d, i) => d3.interpolateCool(i / 8))
                    .attr('stroke', '#00A8FF')
                    .attr('stroke-width', 2)
                    .style('opacity', 0.7)
                    .style('filter', 'drop-shadow(0 0 8px rgba(0, 168, 255, 0.5))');

                arcs.append('text')
                    .attr('transform', d => `translate(${arc.centroid(d)})`)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '10px')
                    .attr('font-weight', 'bold')
                    .attr('fill', '#FFF')
                    .text(d => (d.data.name || d.data.genre || '').substring(0, 8));
            }, [data]);

            if (!data || data.length === 0) {
                return <p className="text-gray-600 text-sm text-center py-12">No genre data yet</p>;
            }

            return <div ref={vizRef} className="flex justify-center neural-glow"></div>;
        }

        // 2. Neural Spectrum Bar - Horizontal bar with waveform gradient
        function NeuralSpectrumBar({ data }) {
            const vizRef = useRef(null);

            // Extract position and direction from data object
            const position = typeof data === 'object' ? (data.position ?? 0.5) : 0.5;
            const direction = typeof data === 'object' ? (data.direction || 'neutral') : 'neutral';

            useEffect(() => {
                if (!vizRef.current) return;
                d3.select(vizRef.current).selectAll('*').remove();

                const width = vizRef.current.clientWidth || 800;
                const height = 120;
                const points = 200;

                const svg = d3.select(vizRef.current)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);

                // Gradient bar - color shifts based on position
                const gradient = svg.append('defs')
                    .append('linearGradient')
                    .attr('id', 'spectrum-gradient')
                    .attr('x1', '0%')
                    .attr('x2', '100%');

                gradient.append('stop')
                    .attr('offset', '0%')
                    .attr('stop-color', '#005CFF')
                    .attr('stop-opacity', 0.8);

                gradient.append('stop')
                    .attr('offset', '50%')
                    .attr('stop-color', '#00A8FF')
                    .attr('stop-opacity', 0.6);

                gradient.append('stop')
                    .attr('offset', '100%')
                    .attr('stop-color', '#AD00FF')
                    .attr('stop-opacity', 0.8);

                // Waveform
                const xScale = d3.scaleLinear().domain([0, points]).range([0, width]);
                const yScale = d3.scaleLinear().domain([-1, 1]).range([height, 0]);

                const line = d3.line()
                    .x((d, i) => xScale(i))
                    .y(d => yScale(d))
                    .curve(d3.curveBasis);

                // Generate wave based on position (0.0 = parasympathetic/slow, 1.0 = sympathetic/fast)
                // Sympathetic: faster, sharper waves (aroused, alert)
                // Parasympathetic: slower, smoother waves (calm, relaxed)
                // Hybrid: medium speed (balanced)
                function generateWave(time) {
                    return d3.range(points).map(i => {
                        const x = i / points;

                        // Frequency increases with position (sympathetic = faster)
                        // Range: 3-12 Hz to show dramatic difference
                        const baseFrequency = 3 + (position * 9); // 0.0 ‚Üí 3Hz, 1.0 ‚Üí 12Hz

                        // Animation speed increases with position (sympathetic = more rapid)
                        const animSpeed = 0.005 + (position * 0.015); // 0.005-0.020

                        // Amplitude: parasympathetic = wider waves, sympathetic = tighter/sharper
                        const amplitude1 = 0.5 - (position * 0.2); // 0.5 ‚Üí 0.3
                        const amplitude2 = 0.1 + (position * 0.2); // 0.1 ‚Üí 0.3

                        // Main wave (slower for parasympathetic, faster for sympathetic)
                        const wave1 = Math.sin((x * baseFrequency + time * animSpeed) * Math.PI) * amplitude1;

                        // Secondary wave (adds sharpness for sympathetic)
                        const secondaryFreq = baseFrequency * (1 + position); // More harmonics in sympathetic
                        const wave2 = Math.sin((x * secondaryFreq + time * animSpeed * 2) * Math.PI) * amplitude2;

                        // Noise component (more chaotic in sympathetic state)
                        const noise = (Math.random() - 0.5) * 0.05 * position;

                        return wave1 + wave2 + noise;
                    });
                }

                const path = svg.append('path')
                    .attr('fill', 'none')
                    .attr('stroke', 'url(#spectrum-gradient)')
                    .attr('stroke-width', 3)
                    .style('filter', 'drop-shadow(0 0 12px rgba(0, 168, 255, 0.8))');

                // Position indicator
                const markerX = position * width;
                svg.append('line')
                    .attr('x1', markerX)
                    .attr('x2', markerX)
                    .attr('y1', 0)
                    .attr('y2', height)
                    .attr('stroke', '#00FFFF')
                    .attr('stroke-width', 2)
                    .attr('stroke-dasharray', '4,4')
                    .style('opacity', 0.6);

                let time = 0;
                function animate() {
                    time += 1;
                    path.attr('d', line(generateWave(time)));
                    requestAnimationFrame(animate);
                }
                animate();
            }, [data, position]);

            // Determine state label based on position
            const getStateLabel = () => {
                if (position < 0.33) return 'Parasympathetic';
                if (position > 0.66) return 'Sympathetic';
                return 'Hybrid';
            };

            return (
                <div className="w-full">
                    <div ref={vizRef} className="w-full neural-glow mb-2"></div>
                    <div className="flex justify-between items-center text-xs text-gray-500 px-2">
                        <span>Parasympathetic</span>
                        <span className="text-primary font-semibold text-sm">
                            {getStateLabel()} ({(position * 100).toFixed(0)}%)
                        </span>
                        <span>Sympathetic</span>
                    </div>
                    <div className="text-center text-xs text-gray-600 mt-1">
                        {position < 0.33 && 'Calm, relaxed, slower waves'}
                        {position >= 0.33 && position <= 0.66 && 'Balanced, medium energy'}
                        {position > 0.66 && 'Aroused, alert, faster waves'}
                    </div>
                </div>
            );
        }

        // 3. Sound Palette Orbital - Orbital visualization with rotating nodes
        function SoundPaletteOrbital({ data }) {
            const vizRef = useRef(null);

            useEffect(() => {
                if (!vizRef.current) return;
                d3.select(vizRef.current).selectAll('*').remove();

                if (!data || !Array.isArray(data) || data.length === 0) return;

                const width = 280;
                const height = 240;

                const svg = d3.select(vizRef.current)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);

                // Draw 3 orbital rings
                [60, 90, 120].forEach((r, idx) => {
                    svg.append('circle')
                        .attr('cx', width / 2)
                        .attr('cy', height / 2)
                        .attr('r', r)
                        .attr('fill', 'none')
                        .attr('stroke', '#00A8FF')
                        .attr('stroke-width', 1)
                        .attr('stroke-opacity', 0.3);
                });

                // Place nodes on orbits
                const nodes = data.slice(0, 12).map((d, i) => {
                    const orbit = [60, 90, 120][i % 3];
                    const angle = (i / (data.length / 3)) * 2 * Math.PI;
                    return {
                        ...d,
                        x: width / 2 + orbit * Math.cos(angle),
                        y: height / 2 + orbit * Math.sin(angle),
                        r: 8 + (d.weight || 1) * 2
                    };
                });

                const nodeGroups = svg.selectAll('g.node')
                    .data(nodes)
                    .enter()
                    .append('g')
                    .attr('class', 'node')
                    .attr('transform', d => `translate(${d.x}, ${d.y})`);

                nodeGroups.append('circle')
                    .attr('r', d => d.r)
                    .attr('fill', '#00A8FF')
                    .attr('stroke', '#005CFF')
                    .attr('stroke-width', 2)
                    .style('opacity', 0.8)
                    .style('filter', 'drop-shadow(0 0 6px rgba(0, 168, 255, 0.8))');

                nodeGroups.append('text')
                    .attr('text-anchor', 'middle')
                    .attr('dy', 4)
                    .attr('font-size', '8px')
                    .attr('fill', '#000')
                    .attr('font-weight', 'bold')
                    .text(d => (d.name || d.sound || '').substring(0, 4));
            }, [data]);

            if (!data || data.length === 0) {
                return <p className="text-gray-600 text-sm text-center py-12">No sound data yet</p>;
            }

            return <div ref={vizRef} className="flex justify-center neural-glow"></div>;
        }

        // 4. Tonal DNA Quadrant - Quadrant visualization showing tonal characteristics
        function TonalDNAQuadrant({ data }) {
            const vizRef = useRef(null);

            // Extract values from object structure {dark_bright: 0.7, minimal_maximal: 0.6}
            const darkBright = typeof data === 'object' && data !== null ? (data.dark_bright ?? 0.5) : 0.5;
            const minimalMaximal = typeof data === 'object' && data !== null ? (data.minimal_maximal ?? 0.5) : 0.5;
            const hasData = typeof data === 'object' && data !== null && (data.dark_bright !== undefined || data.minimal_maximal !== undefined);

            useEffect(() => {
                if (!vizRef.current || !hasData) return;
                d3.select(vizRef.current).selectAll('*').remove();

                const width = 280;
                const height = 240;

                const svg = d3.select(vizRef.current)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);

                // Draw quadrant lines
                svg.append('line')
                    .attr('x1', 0).attr('y1', height / 2)
                    .attr('x2', width).attr('y2', height / 2)
                    .attr('stroke', '#00A8FF')
                    .attr('stroke-width', 1)
                    .attr('stroke-opacity', 0.4);

                svg.append('line')
                    .attr('x1', width / 2).attr('y1', 0)
                    .attr('x2', width / 2).attr('y2', height)
                    .attr('stroke', '#00A8FF')
                    .attr('stroke-width', 1)
                    .attr('stroke-opacity', 0.4);

                // Labels
                const labels = [
                    { text: 'BRIGHT', x: width / 2, y: 15 },
                    { text: 'DARK', x: width / 2, y: height - 10 },
                    { text: 'MINIMAL', x: 20, y: height / 2 + 5 },
                    { text: 'MAXIMAL', x: width - 30, y: height / 2 + 5 }
                ];

                svg.selectAll('text.label')
                    .data(labels)
                    .enter()
                    .append('text')
                    .attr('class', 'label')
                    .attr('x', d => d.x)
                    .attr('y', d => d.y)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '9px')
                    .attr('fill', '#00A8FF')
                    .attr('font-weight', 'bold')
                    .text(d => d.text);

                // Plot position based on values
                // dark_bright: 0=dark (bottom), 1=bright (top)
                // minimal_maximal: 0=minimal (left), 1=maximal (right)
                const x = minimalMaximal * width;
                const y = (1 - darkBright) * height; // Invert Y for screen coordinates

                // Draw position marker
                svg.append('circle')
                    .attr('cx', x)
                    .attr('cy', y)
                    .attr('r', 12)
                    .attr('fill', '#00FFFF')
                    .attr('opacity', 0.8)
                    .style('filter', 'drop-shadow(0 0 12px rgba(0, 255, 255, 0.9))');

                svg.append('circle')
                    .attr('cx', x)
                    .attr('cy', y)
                    .attr('r', 6)
                    .attr('fill', '#FFFFFF')
                    .attr('opacity', 1);

                // Crosshair lines from center to point
                svg.append('line')
                    .attr('x1', width / 2)
                    .attr('y1', height / 2)
                    .attr('x2', x)
                    .attr('y2', y)
                    .attr('stroke', '#00FFFF')
                    .attr('stroke-width', 1)
                    .attr('stroke-dasharray', '3,3')
                    .attr('opacity', 0.5);
            }, [data, darkBright, minimalMaximal, hasData]);

            if (!hasData) {
                return <p className="text-gray-600 text-sm text-center py-12">No tonal data yet</p>;
            }

            return (
                <div>
                    <div ref={vizRef} className="flex justify-center neural-glow mb-2"></div>
                    <div className="text-center text-xs text-gray-500">
                        <span>{(darkBright * 100).toFixed(0)}% Bright, {(minimalMaximal * 100).toFixed(0)}% Maximal</span>
                    </div>
                </div>
            );
        }

        // 5. Rhythmic DNA Waveform - Waveform showing rhythmic patterns
        function RhythmicDNAWaveform({ data }) {
            const vizRef = useRef(null);

            useEffect(() => {
                if (!vizRef.current) return;
                d3.select(vizRef.current).selectAll('*').remove();

                if (!data || !Array.isArray(data) || data.length === 0) return;

                const width = 280;
                const height = 180;

                const svg = d3.select(vizRef.current)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);

                const xScale = d3.scaleLinear()
                    .domain([0, data.length])
                    .range([20, width - 20]);

                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.weight || 1)])
                    .range([height - 30, 30]);

                const area = d3.area()
                    .x((d, i) => xScale(i))
                    .y0(height - 30)
                    .y1(d => yScale(d.weight || 1))
                    .curve(d3.curveCatmullRom);

                svg.append('path')
                    .datum(data.slice(0, 20))
                    .attr('d', area)
                    .attr('fill', 'url(#rhythmic-gradient)')
                    .attr('stroke', '#00A8FF')
                    .attr('stroke-width', 2)
                    .style('filter', 'drop-shadow(0 0 8px rgba(0, 168, 255, 0.6))');

                const gradient = svg.append('defs')
                    .append('linearGradient')
                    .attr('id', 'rhythmic-gradient')
                    .attr('x1', '0%')
                    .attr('y1', '0%')
                    .attr('x2', '0%')
                    .attr('y2', '100%');

                gradient.append('stop')
                    .attr('offset', '0%')
                    .attr('stop-color', '#00A8FF')
                    .attr('stop-opacity', 0.8);

                gradient.append('stop')
                    .attr('offset', '100%')
                    .attr('stop-color', '#005CFF')
                    .attr('stop-opacity', 0.1);
            }, [data]);

            if (!data || data.length === 0) {
                return <p className="text-gray-600 text-sm text-center py-12">No rhythmic data yet</p>;
            }

            return <div ref={vizRef} className="flex justify-center neural-glow"></div>;
        }

        // 6. Emotional Bubble Network - Connected bubble network
        function EmotionalBubbleNetwork({ data }) {
            const vizRef = useRef(null);

            useEffect(() => {
                if (!vizRef.current) return;
                d3.select(vizRef.current).selectAll('*').remove();

                if (!data || !Array.isArray(data) || data.length === 0) return;

                const width = vizRef.current.clientWidth || 700;
                const height = 280;

                const svg = d3.select(vizRef.current)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);

                const simulation = d3.forceSimulation(data.slice(0, 10).map(d => ({
                    ...d,
                    r: Math.sqrt((d.weight || 1) * 50) + 25
                })))
                    .force('charge', d3.forceManyBody().strength(-50))
                    .force('center', d3.forceCenter(width / 2, height / 2))
                    .force('collision', d3.forceCollide().radius(d => d.r + 10));

                const nodeGroups = svg.selectAll('g')
                    .data(simulation.nodes())
                    .enter()
                    .append('g');

                nodeGroups.append('circle')
                    .attr('r', d => d.r)
                    .attr('fill', (d, i) => ['#00A8FF', '#AD00FF', '#4ECDC4', '#FFE66D', '#FF6B6B'][i % 5])
                    .attr('stroke', '#00A8FF')
                    .attr('stroke-width', 2)
                    .style('opacity', 0.7)
                    .style('filter', 'drop-shadow(0 0 10px rgba(0, 168, 255, 0.6))');

                nodeGroups.append('text')
                    .attr('text-anchor', 'middle')
                    .attr('dy', 5)
                    .attr('font-size', d => Math.min(14, d.r / 4))
                    .attr('font-weight', 'bold')
                    .attr('fill', '#FFF')
                    .text(d => (d.emotion || d.name || '').substring(0, 10));

                simulation.on('tick', () => {
                    nodeGroups.attr('transform', d => `translate(${d.x}, ${d.y})`);
                });
            }, [data]);

            if (!data || data.length === 0) {
                return <p className="text-gray-600 text-sm text-center py-12">No emotional data yet</p>;
            }

            return <div ref={vizRef} className="w-full neural-glow"></div>;
        }

        // 7. Data List - Simple list view for text data
        function DataList({ data }) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                return <p className="text-gray-600 text-sm">No data yet</p>;
            }

            return (
                <div className="space-y-2">
                    {data.slice(0, 6).map((item, i) => (
                        <div key={i} className="flex justify-between items-center p-3 rounded-lg bg-black/30 border-l-2 border-primary/50">
                            <span className="text-white text-sm">{item.name || item.type || item.signature || 'Unknown'}</span>
                            <span className="text-xs text-gray-400 bg-primary/10 px-2 py-1 rounded">
                                {Math.round((item.weight || 1) * 10) / 10}
                            </span>
                        </div>
                    ))}
                </div>
            );
        }

        // 8. Inspirational Constellation - Star-like constellation pattern
        function InspirationalConstellation({ data }) {
            const vizRef = useRef(null);

            useEffect(() => {
                if (!vizRef.current) return;
                d3.select(vizRef.current).selectAll('*').remove();

                if (!data || !Array.isArray(data) || data.length === 0) return;

                const width = 280;
                const height = 240;

                const svg = d3.select(vizRef.current)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);

                // Central node
                svg.append('circle')
                    .attr('cx', width / 2)
                    .attr('cy', height / 2)
                    .attr('r', 20)
                    .attr('fill', '#00A8FF')
                    .attr('stroke', '#005CFF')
                    .attr('stroke-width', 2)
                    .style('filter', 'drop-shadow(0 0 10px rgba(0, 168, 255, 0.8))');

                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .attr('dy', 5)
                    .attr('font-size', '10px')
                    .attr('font-weight', 'bold')
                    .attr('fill', '#000')
                    .text('CORE');

                // Surrounding nodes
                data.slice(0, 8).forEach((item, i) => {
                    const angle = (i / data.slice(0, 8).length) * 2 * Math.PI;
                    const radius = 80;
                    const x = width / 2 + radius * Math.cos(angle);
                    const y = height / 2 + radius * Math.sin(angle);

                    // Connecting line
                    svg.append('line')
                        .attr('x1', width / 2)
                        .attr('y1', height / 2)
                        .attr('x2', x)
                        .attr('y2', y)
                        .attr('stroke', '#00A8FF')
                        .attr('stroke-width', 1)
                        .attr('stroke-opacity', 0.3)
                        .attr('class', 'pulse-line');

                    // Node
                    svg.append('circle')
                        .attr('cx', x)
                        .attr('cy', y)
                        .attr('r', 12)
                        .attr('fill', '#005CFF')
                        .attr('stroke', '#00A8FF')
                        .attr('stroke-width', 1.5)
                        .style('opacity', 0.8)
                        .style('filter', 'drop-shadow(0 0 6px rgba(0, 168, 255, 0.6))');

                    // Label
                    svg.append('text')
                        .attr('x', x)
                        .attr('y', y + 25)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', '9px')
                        .attr('fill', '#00A8FF')
                        .text((item.type || item.name || '').substring(0, 8));
                });
            }, [data]);

            if (!data || data.length === 0) {
                return <p className="text-gray-600 text-sm text-center py-12">No trigger data yet</p>;
            }

            return <div ref={vizRef} className="flex justify-center neural-glow"></div>;
        }

        // 9. Sonic Architecture - Display layering approach and tension/release
        function SonicArchitectureTower({ data }) {
            // Extract text properties from object structure
            const layeringApproach = typeof data === 'object' && data !== null ? (data.layering_approach || data.layering) : null;
            const tensionRelease = typeof data === 'object' && data !== null ? (data.tension_release || data.tension) : null;
            const hasData = layeringApproach || tensionRelease;

            if (!hasData) {
                return <p className="text-gray-600 text-sm text-center py-12">No architecture data yet</p>;
            }

            return (
                <div className="space-y-4 px-6">
                    {layeringApproach && (
                        <div className="p-4 rounded-lg bg-black/30 border-l-4 border-primary">
                            <p className="text-xs text-primary font-semibold uppercase tracking-wider mb-2">Layering Approach</p>
                            <p className="text-white text-sm leading-relaxed">{layeringApproach}</p>
                        </div>
                    )}
                    {tensionRelease && (
                        <div className="p-4 rounded-lg bg-black/30 border-l-4 border-purple-500">
                            <p className="text-xs text-purple-400 font-semibold uppercase tracking-wider mb-2">Tension & Release</p>
                            <p className="text-white text-sm leading-relaxed">{tensionRelease}</p>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
